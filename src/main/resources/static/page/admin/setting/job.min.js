var pageSize=10,currentIndex=0,totalPage=0;layui.use(["layer","laypage"],function(){layer=layui.layer;laypage=layui.laypage;$addOrEditModal=$("#add-or-edit-job");$("#totalCheckbox").change(function(){$(this).hasClass("checked")?($("tr.each-row").find("input[type\x3d'checkbox']").each(function(){$(this).removeAttr("checked")}),$(this).removeClass("checked")):($("tr.each-row").find("input[type\x3d'checkbox']").each(function(){$(this).prop("checked",!0)}),$(this).addClass("checked"))});$tableContainer=$(".table");getJobs()});var jobs,$addOrEditModal,$tableContainer;function getJobs(){var a=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/jm/jobs?"+jsonToGetRequestParams(getQueryPagingParams()),dataType:"json",beforeSend:function(){},success:function(b){layer.close(a);$tableContainer.find(".each-row").remove();if(b.success)if(0==b.message.length)0==currentIndex?$tableContainer.append('\x3ctr class\x3d"each-row"\x3e\x3ctd colspan\x3d"11"\x3e\u6682\u65f6\u8fd8\u6ca1\u6709\u4efb\u4f55\u5b9a\u65f6\u4efb\u52a1\uff01\x3c/td\x3e\x3c/tr\x3e'):($tableContainer.append('\x3ctr class\x3d"each-row"\x3e\x3ctd colspan\x3d"11"\x3e\u5df2\u7ecf\u6ca1\u6709\u66f4\u591a\u7684\u5b9a\u65f6\u4efb\u52a1\u5566\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9\uff01\x3c/td\x3e\x3c/tr\x3e'),pageDivUtil(b.total));else{jobs=b.message;for(var c=0;c<jobs.length;c++)$tableContainer.append(buildRow(jobs[c],c)),1!=jobs[c].status&&$tableContainer.find(".each-row").eq(c).addClass("status-disabled-row");laypage.render({elem:"job-pager",layout:["prev","page","next","count","skip"],count:b.total,limit:pageSize,curr:currentIndex+1,jump:function(a,b){console.log(a.curr);console.log(a.limit);b||(currentIndex=a.curr-1,getJobs())}})}else ajaxError(b)},error:function(b){layer.close(a);isLoad=!1;ajaxError(b)}})}function addJob(){$addOrEditModal.attr("data-id","");$addOrEditModal.find('input[name\x3d"job_group"]').val("");$addOrEditModal.find('input[name\x3d"expression"]').val("");$addOrEditModal.find('input[name\x3d"class_name"]').val("");$addOrEditModal.find('input[name\x3d"job_name"]').val("");$addOrEditModal.find('input[name\x3d"job_params"]').val("");$addOrEditModal.find('input[name\x3d"job_order"]').val("");$addOrEditModal.find('textarea[name\x3d"job_desc"]').val("");$addOrEditModal.find('input[name1\x3d"status_normal"]').prop("checked",!0);$addOrEditModal.find('input[name1\x3d"status_disabled"]').removeAttr("checked");$addOrEditModal.modal("show")}function editJob(){var a=$("tr.each-row").find('input[type\x3d"checkbox"]:checked');a&&0!=a.length?a&&1<a.length?layer.msg("\u4e00\u6b21\u53ea\u80fd\u7f16\u8f91\u4e00\u4e2a\u4efb\u52a1"):(a=jobs[$(a[0]).closest("tr").attr("index")],$addOrEditModal.attr("data-id",a.id),$addOrEditModal.find('input[name\x3d"job_group"]').val(a.job_group),$addOrEditModal.find('input[name\x3d"expression"]').val(a.expression),$addOrEditModal.find('input[name\x3d"class_name"]').val(a.class_name),$addOrEditModal.find('input[name\x3d"job_name"]').val(a.job_name),$addOrEditModal.find('input[name\x3d"job_params"]').val(a.job_params),$addOrEditModal.find('input[name\x3d"job_order"]').val(a.job_order),$addOrEditModal.find('textarea[name\x3d"job_desc"]').val(a.job_desc),1==a.status?($addOrEditModal.find('input[name1\x3d"status_normal"]').prop("checked",!0),$addOrEditModal.find('input[name1\x3d"status_disabled"]').removeAttr("checked")):($addOrEditModal.find('input[name1\x3d"status_disabled"]').prop("checked",!0),$addOrEditModal.find('input[name1\x3d"status_normal"]').removeAttr("checked")),$addOrEditModal.modal("show")):layer.msg("\u8bf7\u9009\u62e9\u60a8\u8981\u7f16\u8f91\u7684\u4efb\u52a1")}function rowEditJob(a){a=$(a).closest("tr.each-row").attr("index");a=jobs[a];$addOrEditModal.attr("data-id",a.id);$addOrEditModal.find('input[name\x3d"job_group"]').val(a.job_group);$addOrEditModal.find('input[name\x3d"expression"]').val(a.expression);$addOrEditModal.find('input[name\x3d"class_name"]').val(a.class_name);$addOrEditModal.find('input[name\x3d"job_name"]').val(a.job_name);$addOrEditModal.find('input[name\x3d"job_params"]').val(a.job_params);$addOrEditModal.find('input[name\x3d"job_order"]').val(a.job_order);$addOrEditModal.find('textarea[name\x3d"job_desc"]').val(a.job_desc);1==a.status?($addOrEditModal.find('input[name1\x3d"status_normal"]').prop("checked",!0),$addOrEditModal.find('input[name1\x3d"status_disabled"]').removeAttr("checked")):($addOrEditModal.find('input[name1\x3d"status_disabled"]').prop("checked",!0),$addOrEditModal.find('input[name1\x3d"status_normal"]').removeAttr("checked"));$addOrEditModal.modal("show")}function rowDeleteJob(a){var b=$(a).closest("tr.each-row").attr("data-id");layer.confirm("\u60a8\u8981\u5220\u9664\u8fd91\u6761\u4efb\u52a1\u8bb0\u5f55\u5417\uff1f",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){var a=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"delete",url:"/jm/job/"+b,dataType:"json",beforeSend:function(){},success:function(b){layer.close(a);b.success?(layer.msg(b.message+",1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(b)},error:function(b){layer.close(a);ajaxError(b)}})},function(){})}function deletesJob(){var a=$("tr.each-row").find('input[type\x3d"checkbox"]:checked');a&&0!=a.length?layer.confirm("\u60a8\u8981\u5220\u9664\u8fd9"+a.length+"\u6761\u4efb\u52a1\u8bb0\u5f55\u5417\uff1f",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){for(var b="",c=0;c<a.length;c++)b+=$(a[c]).closest("tr.each-row").attr("data-id")+",";var b=deleteLastStr(b),d=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"delete",url:"/jm/jobs?pmids\x3d"+b,dataType:"json",beforeSend:function(){},success:function(a){layer.close(d);a.success?(layer.msg(a.message+",1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(a)},error:function(a){layer.close(d);ajaxError(a)}})},function(){}):layer.msg("\u8bf7\u9009\u62e9\u60a8\u8981\u5220\u9664\u7684\u4efb\u52a1")}function addOrEditCommit(a){a=$(a).closest(".modal");var b=a.attr("data-id"),c={},d=!0;a.find(".form-control").each(function(a){a=$(this).attr("name");var b=$(this).attr("empty");if(b&&"false"==b&&isEmpty($(this).val()))return $(this).focus(),layer.msg($(this).attr("placeholder")),d=!1;c[a]=$(this).val()});if(d){c.id=b;c.status=a.find('input[name\x3d"status"]:checked').val();console.log(c);var e=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:isEmpty(b)?"post":"put",data:c,url:"/jm/job",dataType:"json",beforeSend:function(){},success:function(a){layer.close(e);a.success?(layer.msg(a.message+",1\u79d2\u949f\u540e\u81ea\u52a8\u5237\u65b0"),setTimeout("window.location.reload();",1E3)):ajaxError(a)},error:function(a){layer.close(e);ajaxError(a)}})}}function getQueryPagingParams(){return{page_size:pageSize,current:currentIndex,total:totalPage,t:Math.random()}}function buildRow(a,b){return'\x3ctr class\x3d"each-row" data-id\x3d"'+a.id+'" index\x3d"'+b+'"\x3e\x3ctd\x3e\x3cinput type\x3d"checkbox" /\x3e\x3c/td\x3e\x3ctd\x3e'+changeNotNullString(a.job_name)+"\x3c/td\x3e\x3ctd\x3e"+a.job_group+"\x3c/td\x3e\x3ctd\x3e"+a.expression+"\x3c/td\x3e\x3ctd\x3e"+a.class_name+"\x3c/td\x3e\x3ctd\x3e"+changeNotNullString(a.job_params)+"\x3c/td\x3e\x3ctd\x3e"+changeNotNullString(a.job_order)+"\x3c/td\x3e\x3ctd\x3e"+changeNotNullString(a.job_desc)+"\x3c/td\x3e\x3ctd\x3e"+(1==a.status?"\u6b63\u5e38":"\u7981\u7528")+"\x3c/td\x3e\x3ctd\x3e"+a.create_time+'\x3c/td\x3e\x3ctd\x3e\x3ca href\x3d"javascript:void(0);" onclick\x3d"rowEditJob(this);" style\x3d"margin-right: 10px;"\x3e\u7f16\u8f91\x3c/a\x3e\x3ca href\x3d"javascript:void(0);" onclick\x3d"rowDeleteJob(this);" style\x3d"margin-right: 10px;"\x3e\u5220\u9664\x3c/a\x3e\x3c/td\x3e\x3c/tr\x3e'};