layui.use(["layer"],function(){layer=layui.layer;initPage(".pagination","getCircles");$circleEditModal=$("#edit-circle-modal");$("[data-toggle\x3d'tooltip']").tooltip();$(".navbar-nav .nav-main-li").each(function(){$(this).removeClass("active")});$(".nav-circle").addClass("active");$(".tooltip").css("display","block");$tableContainer=$(".table tbody");$(".create-circle").click(function(){$.ajax({url:"/cc/check",dataType:"json",beforeSend:function(){},success:function(a){a.isSuccess?showCreateModal(a.message):ajaxError(a)},error:function(a){ajaxError(a)}})});getCircles()});var circles,$circleEditModal,$tableContainer;function getCircles(){var a=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/cc/circles?"+jsonToGetRequestParams({page_size:pageSize,current:currentIndex,total:totalPage,t:Math.random()}),dataType:"json",beforeSend:function(){$tableContainer.find("tr").remove();$(".pagination").empty()},success:function(b){layer.close(a);if(b.isSuccess){circles=b.message;if(0==circles.length){0==currentIndex?$tableContainer.append('\x3ctr\x3e\x3ctd colspan\x3d"7"\x3e\u60a8\u8fd8\u672a\u52a0\u5165\u4efb\u4f55\u7684\u5708\u5b50\uff01\x3c/td\x3e\x3c/tr\x3e'):($tableContainer.append('\x3ctr\x3e\x3ctd colspan\x3d"7"\x3e\u5df2\u7ecf\u6ca1\u6709\u66f4\u591a\u7684\u5708\u5b50\u5566\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9\uff01\x3c/td\x3e\x3c/tr\x3e'),pageDivUtil(b.total));return}for(var c=0;c<circles.length;c++)$tableContainer.append(buildEachCircleRow(c,circles[c])),$("#row-index-"+c).data("circle",circles[c]);pageDivUtil(b.total)}else ajaxError(b);isLoad=!1},error:function(b){isLoad=!1;layer.close(a);ajaxError(b)}})}function buildEachCircleRow(a,b){var c='\x3ctr id\x3d"row-index-'+a+'"\x3e\x3ctd width\x3d"30"\x3e\x3cimg alt\x3d"" src\x3d"'+(isEmpty(b.circle_path)?"":b.circle_path)+'" width\x3d"25" height\x3d"25"/\x3e\x3c/td\x3e\x3ctd width\x3d"150" class\x3d"cut-text"\x3e\x3ca href\x3d"javascript:void(0);" onclick\x3d"linkToCircle('+b.id+');"\x3e'+b.name+"\x3c/a\x3e\x3c/td\x3e\x3ctd\x3e"+b.create_user_name+"\x3c/td\x3e\x3ctd\x3e";isNotEmpty(b.admins)&&(c+=changeNotNullString(getAdminMapValue(b.adminMap)));var c=c+("\x3c/td\x3e\x3ctd\x3e"+b.circle_desc+"\x3c/td\x3e"),d="";1==b.status?d="\u6b63\u5e38":2==b.status?d="\u5df2\u5220\u9664":5==b.status?d="\u79c1\u6709":0==b.status&&(d="\u7981\u7528");c+='\x3ctd width\x3d"60"\x3e'+d+'\x3c/td\x3e\x3ctd width\x3d"100"\x3e'+b.create_time+'\x3c/td\x3e\x3ctd width\x3d"140"\x3e';b.create_user_id==loginUserId&&(c+='\x3ca href\x3d"javascript:void(0);" onclick\x3d"showAllotAdminList(this, '+b.id+');" style\x3d"margin-right: 10px;"\x3e\u5206\u914d\x3c/a\x3e\x3ca href\x3d"javascript:void(0);" onclick\x3d"showEditCircleModal(this, '+a+');" style\x3d"margin-right: 10px;"\x3e\u7f16\u8f91\x3c/a\x3e\x3ca href\x3d"javascript:void(0);" onclick\x3d"doDelete(this, '+a+');" style\x3d"margin-right: 10px;"\x3e\u5220\u9664\x3c/a\x3e',1==b.status&&(c+='\x3ca href\x3d"javascript:void(0);" onclick\x3d"doSelf(this, '+a+');" style\x3d"margin-right: 10px;"\x3e\u8bbe\u7f6e\u79c1\u6709\x3c/a\x3e'));return c+"\x3c/td\x3e\x3c/tr\x3e"}function showAllotAdminList(a,b){var c=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/cc/"+b+"/admins",dataType:"json",beforeSend:function(){$("#alreadyAdmins").html("");$("#notAdmins").html("")},success:function(a){layer.close(c);if(a.isSuccess){for(var e=0;e<a.message.length;e++)0==a.message[e].role_type?buildNotAdminsHtml(a.message[e]):2==a.message[e].role_type&&buildAlreadyAdminsHtml(a.message[e]);$("#admin-list").modal("show");$("#admin-list").attr("data-id",b)}else ajaxError(a)},error:function(a){layer.close(c);ajaxError(a)}})}function buildNotAdminsHtml(a){a='\x3cspan class\x3d"label label-info" data-id\x3d"'+a.member_id+'" onclick\x3d"notClick(this);"\x3e'+a.account+"\x3c/span\x3e";$("#notAdmins").append(a)}function buildAlreadyAdminsHtml(a){a='\x3cspan class\x3d"label label-primary" data-id\x3d"'+a.member_id+'" onclick\x3d"alreadyClick(this);"\x3e'+a.account+"\x3c/span\x3e";$("#alreadyAdmins").append(a)}function notClick(a){var b={};b.member_id=$(a).attr("data-id");b.account=$(a).text();$(a).remove();buildAlreadyAdminsHtml(b)}function alreadyClick(a){var b={};b.member_id=$(a).attr("data-id");b.account=$(a).text();$(a).remove();buildNotAdminsHtml(b)}function admin(a){a=$(a).closest(".modal");var b=a.attr("data-id"),c="";a.find("#alreadyAdmins span").each(function(){c+=$(this).attr("data-id")+","});var c=deleteLastStr(c),d=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/cc/"+b+"/admins/allot?admins\x3d"+c,dataType:"json",beforeSend:function(){},success:function(a){layer.close(d);a.isSuccess?(layer.msg(a.message+",1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(a)},error:function(a){layer.close(d);ajaxError(a)}})}function getAdminMapValue(a){if(a){var b="",c;for(c in a)b+='\x3ca href\x3d"javascript: void(0);" onclick\x3d"linkToMy('+c+');"\x3e'+a[c]+"\x3c/a\x3e,";return deleteLastStr(b)}return""}function getCircleData(a){return $("#row-index-"+a).data("circle")}function showEditCircleModal(a,b){$circleEditModal.modal("show");$circleEditModal.attr("data-index",b);var c=getCircleData(b);$circleEditModal.find('input[name\x3d"name"]').val(c.name);$circleEditModal.find('textarea[name\x3d"circle_desc"]').val(changeNotNullString(c.circle_desc));$circleEditModal.find('input[name\x3d"circle_path"]').val(changeNotNullString(c.circle_path))}function doEdit(a){a=$(a).closest(".modal");var b=$("#row-index-"+a.attr("data-index")).data("circle").id,c={},d=!0;a.find(".form-control").each(function(a){a=$(this).attr("name");var b=$(this).attr("empty");if(b&&"false"==b&&isEmpty($(this).val()))return $(this).focus(),layer.msg($(this).attr("placeholder")),d=!1;c[a]=$(this).val()});if(d){c.cid=b;console.log(c);var e=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:isEmpty(b)?"post":"put",data:c,url:"/cc/"+b,dataType:"json",beforeSend:function(){},success:function(a){layer.close(e);a.isSuccess?(layer.msg(a.message+",1\u79d2\u949f\u540e\u81ea\u52a8\u5237\u65b0"),setTimeout("window.location.reload();",1E3)):ajaxError(a)},error:function(a){layer.close(e);ajaxError(a)}})}}function doDelete(a,b){$(a).closest("tr.each-row");var c=getCircleData(b).id;layer.confirm("\u60a8\u8981\u5220\u9664\u8fd91\u6761\u5708\u5b50\u5417\uff1f",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){var a=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"delete",url:"/cc/"+c,dataType:"json",beforeSend:function(){},success:function(b){layer.close(a);b.isSuccess?(layer.msg(b.message+",1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(b)},error:function(b){layer.close(a);ajaxError(b)}})},function(){})}function doSelf(a,b){}function showCreateModal(a){layer.prompt({title:"\u8f93\u5165\u5708\u5b50\u540d\u79f0\u5e76\u786e\u8ba4(\u8fd8\u80fd\u521b\u5efa"+a+"\u4e2a)",formType:0},function(a,c){var b=layer.load(1,{shade:[.1,"#fff"]});$.ajax({type:"POST",url:"/cc/circle",data:{name:a},dataType:"json",beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?(layer.msg(a.message),layer.close(c)):ajaxError(a)},error:function(a){layer.close(b);ajaxError(a)}})})}function afterSelect(a){$('input[name\x3d"circle_path"]').val(a)};