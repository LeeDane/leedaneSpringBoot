layui.use(["laypage","layer"],function(){laypage=layui.laypage;layer=layui.layer;getInit();getPosts()});var posts,$postListContainer,currentIndex=0,pageSize=8;function bindTool(){$("[data-toggle\x3d'tooltip']").tooltip();$(".tooltip").css("display","block");$("[data-toggle\x3d'popover']").popover()}$(function(){$(".navbar-nav .nav-main-li").each(function(){$(this).removeClass("active")});$(".nav-circle").addClass("active");$postListContainer=$("#post-list");bindTool();$(document).on("click",".user-img",function(a){a.stopPropagation();a=$(this).attr("data");linkToMy(a)});$(document).on("click",".link-to-post-detail",function(a){a.stopPropagation();a=$(this).closest(".panel").data("post");linkToPostDetail(a.circle_id,a.id)});$(document).on("click",".post-zan",function(a){a.stopPropagation();addZan($(this))});$(document).on("click",".post-comment",function(a){a.stopPropagation();addComment($(this))});$(document).on("click",".post-transmit",function(a){a.stopPropagation();addTransmit($(this))});$(document).on("click",".post-delete",function(a){a.stopPropagation();deletePost($(this))});$(document).on("click",".post-update",function(a){a.stopPropagation();a=$(this).data("id");isEmpty(a)?layer.msg("\u8be5\u5e16\u5b50\u4e0d\u5b58\u5728\uff0c\u8bf7\u8054\u7cfb\u7ba1\u7406\u5458\u6838\u5b9e"):window.open("/cc/"+circleId+"/write?postId\x3d"+a,"_self")});$(".into-circle").click(function(){$.ajax({url:"/cc/"+circleId+"/join/check",dataType:"json",beforeSend:function(){},success:function(a){a.isSuccess?a.message?layer.prompt({title:a.question,formType:0},function(b,a){layer.load(1,{shade:[.1,"#fff"]});joinCircle(b)}):layer.confirm("\u60a8\u786e\u5b9a\u52a0\u5165\u8be5\u5708\u5b50\u5417\uff1f",{btn:["\u786e\u5b9a","\u653e\u5f03"]},function(){joinCircle()},function(){}):ajaxError(a)},error:function(a){ajaxError(a)}})});$(".circle-leave").click(function(){layer.confirm("\u60a8\u786e\u5b9a\u9000\u51fa\u8be5\u5708\u5b50\u5417\uff1f\u9000\u51fa\u5c06\u6e05\u7a7a\u60a8\u5173\u4e8e\u8be5\u5708\u5b50\u7684\u5168\u90e8\u8bb0\u5f55\uff0c\u4e0d\u53ef\u6062\u590d\uff0c\u8bf7\u8c28\u614e\uff01",{btn:["\u786e\u5b9a","\u653e\u5f03"]},function(){leaveCircle()},function(){})});$(".add-clock-in").click(function(){doClockIn()})});function getInit(){$.ajax({url:"/cc/"+circleId+"/init",dataType:"json",beforeSend:function(){},success:function(a){if(a.isSuccess){if($("#todayVisitors").text(a.message.todayVisitors),$("#visitors").text(a.message.visitors),$("#allContribute").text(a.message.allContribute),$("#myContribute").text(a.message.myContribute),$(".memberNumber").text(a.message.memberNumber),isNotEmpty(a.message.admins)&&0<a.message.admins.length)for(var b=0;b<a.message.admins.length;b++)$("#admins").append('\x3ca th:onclick\x3d"linkToMy('+a.message.admins[b].member_id+');" href\x3d"javascript:void(0);"\x3e'+a.message.admins[b].account+"\x3c/a\x3e\x26nbsp;\x26nbsp;")}else ajaxError(a)},error:function(a){ajaxError(a)}})}function getPosts(){var a=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/cc/"+circleId+"/posts?"+jsonToGetRequestParams({page_size:pageSize,current:currentIndex,t:Math.random()}),dataType:"json",beforeSend:function(){$postListContainer.empty();$(".pagination").empty()},success:function(b){layer.close(a);if(b.isSuccess){posts=b.message;if(0==posts.length){0==currentIndex?($postListContainer.append('\u8be5\u5708\u5b50\u8fd8\u6ca1\u6709\u5e16\u5b50\uff0c\u60a8\u53ef\u4ee5\x3ca href\x3d"/cc/'+circleId+'/write" class\x3d"btn btn-warning btn-sm circle-post" role\x3d"button" data-toggle\x3d"tooltip" title\x3d"\u53d1\u8868\u5173\u4e8e\u8be5\u5708\u5b50\u7684\u5e16\u5b50"\x3e\u5199\u5e16\u5b50\x3c/a\x3e'),bindTool()):$postListContainer.append("\u5df2\u7ecf\u6ca1\u6709\u66f4\u591a\u7684\u5e16\u5b50\uff01");return}for(var c=0;c<posts.length;c++)$postListContainer.append(buildEachPostRow(c,posts[c])),$("#post-list-"+c).data("post",posts[c]);$("#postNumbers").text(b.total);bindTool();laypage.render({elem:"item-pager",layout:["prev","page","next","count","skip"],count:b.total,limit:pageSize,curr:currentIndex+1,jump:function(b,a){console.log(b.curr);console.log(b.limit);a||(currentIndex=b.curr-1,getPosts())}})}else ajaxError(b);isLoad=!1},error:function(b){isLoad=!1;layer.close(a);ajaxError(b)}})}function buildEachPostRow(a,b){var c='\x3cdiv class\x3d"panel panel-default" id\x3d"post-list-'+a+'"\x3e\x3cdiv class\x3d"panel-heading"\x3e\x3cp\x3e'+b.title+'\x3c/p\x3e\x3cdiv\x3e\x3cbutton type\x3d"button" class\x3d"btn btn-default btn-xs user-img" data\x3d"'+b.create_user_id+'"\x3e\x3cimg src\x3d"'+b.user_pic_path+'" class\x3d"img-circle" style\x3d"width: 20px; height: 20px" /\x3e '+b.account+'\x3c/button\x3e\x26nbsp;\x26nbsp;\x3cspan class\x3d"label label-info tag"\x3e'+(1==b.role_type?"\u5708\u4e3b":2==b.role_type?"\u7ba1\u7406\u5458":"\u666e\u901a")+"\x3c/span\x3e\x26nbsp;\x26nbsp;"+b.create_time+"\x3c/div\x3e";if(isNotEmpty(b.tag)){for(var c=c+'\x3cp style\x3d"margin-top: 10px;"\x3e\u6807\u7b7e\uff1a',d=b.tag.split(","),e=0;e<d.length;e++)c+='\x3cspan class\x3d"post-tag"\x3e'+d[e]+"\x3c/span\x3e";c+="\x3c/p\x3e"}c+='\x3c/div\x3e\x3cdiv class\x3d"panel-body panel-table-container"\x3e';0<b.pid&&(c+='\x3cdiv class\x3d"col-lg-12 col-sm-12 col-md-12 col-xs-12"\x3e\x3cblockquote\x3e\x3cdiv class\x3d"cut-text hand"\x3e\x3ca '+(b.blockquote?'data-toggle\x3d"tooltip" data-placement\x3d"left" title\x3d"\u67e5\u770b\u8be5\u5e16\u5b50\u8be6\u7ec6\u4fe1\u606f"':"")+' onclick\x3d"linkToPostDetail('+b.circle_id+","+b.pid+');"\x3e'+b.blockquote_content+"\x3c/a\x3e\x3c/div\x3e",b.blockquote&&(c+="\x3csmall\x3e\x3ccite\x3e"+b.blockquote_account+"\x3c/cite\x3e\x26nbsp;\x26nbsp;"+b.blockquote_time+"\x3c/small\x3e"),c+="\x3c/blockquote\x3e\x3c/div\x3e");c+='\x3cdiv class\x3d"col-lg-12 col-sm-12 col-md-12 col-xs-12 cut-text2" data-toggle\x3d"tooltip" data-placement\x3d"left" title\x3d"'+changeNotNullString(b.digest)+'"\x3e'+changeNotNullString(b.digest)+"\x3c/div\x3e";if(isNotEmpty(b.imgs))for(d=b.imgs.split(";"),e=0;e<d.length;e++)isVideo(d[e])?(c+='\x3cdiv class\x3d"col-lg-4 col-sm-4 col-md-12 col-xs-12 img-container"\x3e',c+=getVideoHtml(d[e]),c+="\x3c/div\x3e"):isAudio(d[e])?(c+='\x3cdiv class\x3d"col-lg-4 col-sm-4 col-md-12 col-xs-12 img-container"\x3e',c+=getAudioHtml(d[e]),c+="\x3c/div\x3e"):isImg(d[e])?c+='\x3cdiv class\x3d"col-lg-4 col-sm-4 col-md-12 col-xs-12 img-container"\x3e\x3cimg src\x3d"'+d[e]+'" class\x3d"img-responsive post-item-img hand" onClick\x3d"showImgDialog('+e+", '"+b.imgs+"');\" /\x3e\x3c/div\x3e":layer.msg(getSupportTypeStr());c+='\x3c/div\x3e\x3cdiv class\x3d"panel-footer" style\x3d"color: #666;"\x3e';if(isNotEmpty(b.zan_users)){for(var d=b.zan_users.split(";"),e="",g=0;g<d.length;g++){var f=d[g];isNotEmpty(f)&&2==f.split(",").length&&(e=g!=d.length-1?e+('\x3ca href\x3d"JavaScript:void(0);" onclick\x3d"linkToMy('+f.split(",")[0]+')"\x3e'+changeNotNullString(f.split(",")[1])+"\x3c/a\x3e\u3001"):e+('\x3ca href\x3d"JavaScript:void(0);" onclick\x3d"linkToMy('+f.split(",")[0]+')"\x3e'+changeNotNullString(f.split(",")[1])+"\x3c/a\x3e"))}c+="\x3cp\x3e"+e+"\x26nbsp;\u7b49"+b.zan_number+"\u4eba\u89c9\u5f97\u5f88\u8d5e\x3c/p\x3e"}c+="\x3cp\x3e";if(isCreater||isCircleAdmin||loginUserId==b.create_user_id)c+='\x3cspan class\x3d"glyphicon glyphicon-trash post-delete hand" data-toggle\x3d"tooltip" data-placement\x3d"left" title\x3d"\u5220\u9664" aria-hidden\x3d"true"\x3e\x3c/span\x3e\x26nbsp;\x26nbsp;';loginUserId==b.create_user_id&&(c+='\x3cspan class\x3d"glyphicon glyphicon-pencil post-update hand" data-toggle\x3d"tooltip" data-placement\x3d"left" title\x3d"\u7f16\u8f91" aria-hidden\x3d"true" data-id\x3d"'+b.id+'"\x3e\x3c/span\x3e\x26nbsp;\x26nbsp;');return c+='\x3cspan class\x3d"glyphicon glyphicon-comment hand post-comment" data-toggle\x3d"tooltip" data-placement\x3d"left" title\x3d"\u8bc4\u8bba" aria-hidden\x3d"true"\x3e\x3c/span\x3e\x26nbsp;'+b.comment_number+'\x26nbsp;\x26nbsp;\x3cspan class\x3d"glyphicon glyphicon-share-alt hand post-transmit" data-toggle\x3d"tooltip" data-placement\x3d"left" title\x3d"\u8f6c\u53d1" aria-hidden\x3d"true"\x3e\x3c/span\x3e\x26nbsp;'+b.transmit_number+'\x26nbsp;\x26nbsp;\x3cspan class\x3d"glyphicon glyphicon-thumbs-up hand post-zan" data-toggle\x3d"tooltip" data-placement\x3d"left" title\x3d"\u5f88\u8d5e" aria-hidden\x3d"true"\x3e\x3c/span\x3e\x26nbsp;'+b.zan_number+'\x26nbsp;\x26nbsp;\x3cspan class\x3d"glyphicon glyphicon-credit-card hand" data-toggle\x3d"tooltip" data-placement\x3d"left" title\x3d"\u6253\u8d4f" aria-hidden\x3d"true"\x3e\x3c/span\x3e\x26nbsp;0\x26nbsp;\x26nbsp;\x3cspan class\x3d"hand link-to-post-detail" data\x3d"'+b.id+'"\x3e\u67e5\u770b\u8be6\u60c5\x3c/a\x3e\x3c/p\x3e\x3c/div\x3e\x3c/div\x3e'}function showImgDialog(a,b){for(var c={title:"\u76f8\u518c\u6807\u9898",id:0,start:a},d=[],e=b.split(";"),g=0;g<e.length;g++){var f={},h=e[g];f.src=h;f.alt=h;d.push(f)}c.data=d;layer.photos({photos:c,shift:1})}function joinCircle(a){var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"POST",data:{cid:circleId,answer:a},url:"/cc/"+circleId+"/join",dataType:"json",beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?(layer.msg(a.message+"\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(a)},error:function(a){layer.close(b);ajaxError(a)}})}function leaveCircle(){var a=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"DELETE",url:"/cc/"+circleId+"/leave",dataType:"json",beforeSend:function(){},success:function(b){layer.close(a);b.isSuccess?(layer.msg("\u79bb\u5f00\u8be5\u5708\u5b50\u6210\u529f\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(b)},error:function(b){layer.close(a);ajaxError(b)}})}function doClockIn(){var a=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"POST",data:{forms:"web\u7f51\u9875\u7aef"},url:"/cc/"+circleId+"/clockIn",dataType:"json",beforeSend:function(){},success:function(b){layer.close(a);b.isSuccess?(layer.msg("\u60a8\u5df2\u7ecf\u6253\u5361\u6210\u529f\uff0c\u660e\u5929\u8bb0\u5f97\u65e9\u70b9\u8fc7\u6765\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(b)},error:function(b){layer.close(a);ajaxError(b)}})}function addZan(a){a=$(a).closest(".panel").data("post");var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"post",data:{table_name:"t_circle_post",content:"\u559c\u6b22",froms:"\u7f51\u9875\u7aef",table_id:a.id},url:"/cc/"+circleId+"/post/"+a.id+"/zan",dataType:"json",beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?(layer.msg(a.message+"\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):layer.msg(a.message)},error:function(){layer.close(b);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})}function addComment(a){var b=$(a).closest(".panel").data("post"),c={table_name:"t_circle_post",table_id:b.id,froms:"web\u7f51\u9875\u7aef"};layer.prompt({title:"\u8bf7\u8f93\u5165\u60a8\u60f3\u8bf4\u7684\u5185\u5bb9",formType:0},function(a,e){layer.load(1,{shade:[.1,"#fff"]});var d=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");c.content=a;$.ajax({type:"post",data:c,url:"/cc/"+circleId+"/post/"+b.id+"/comment",dataType:"json",beforeSend:function(){},success:function(a){layer.close(d);a.isSuccess?(layer.msg(a.message+"\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):(layer.msg(a.message),layer.close(d))},error:function(){layer.close(d);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})})}function addTransmit(a){var b=$(a).closest(".panel").data("post"),c={froms:"web\u7f51\u9875\u7aef"};layer.prompt({title:"\u8bf7\u8f93\u5165\u60a8\u60f3\u8bf4\u7684\u5185\u5bb9",formType:0},function(a,e){layer.load(1,{shade:[.1,"#fff"]});var d=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");c.content=a;c.title="\u8f6c\u53d1\u5e16\u5b50";$.ajax({type:"post",data:c,url:"/cc/"+circleId+"/post/"+b.id+"/transmit",dataType:"json",beforeSend:function(){},success:function(a){layer.close(d);a.isSuccess?(layer.msg(a.message+"\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):(layer.msg(a.message),layer.close(d))},error:function(){layer.close(d);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})})}function deletePost(a){var b=$(a).closest(".panel").data("post");layer.confirm("\u60a8\u8981\u5220\u9664\u8be5\u6761\u5e16\u5b50\u5417\uff1f\u5220\u9664\u6389\u5c06\u65e0\u6cd5\u6062\u590d\uff0c\u8bf7\u614e\u91cd\uff01",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){b.create_user_id==loginUserId?doDelete(b.id,""):layer.prompt({title:"\u8bf7\u8f93\u5165\u60a8\u8981\u5220\u9664\u8be5\u5e16\u5b50\u7684\u539f\u56e0(\u5fc5\u586b)",formType:0},function(a,d){layer.load(1,{shade:[.1,"#fff"]});doDelete(b.id,a)})},function(){})}function doDelete(a,b){var c=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"DELETE",url:"/cc/"+circleId+"/post/"+a+"?reason\x3d"+b,dataType:"json",beforeSend:function(){},success:function(a){layer.close(c);a.isSuccess?(layer.msg(a.message+"\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):(layer.msg(a.message),layer.close(c))},error:function(){layer.close(c);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})};