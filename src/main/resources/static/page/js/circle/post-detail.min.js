layui.use(["layer","laypage","util"],function(){layer=layui.layer;laypage=layui.laypage;util=layui.util;$container=$(".container");$commentContainer=$("#comment-list-container");audit||getComments();$container.on("click",".reply-other-btn",function(){$(this).closest(".list-group").find(".reply-container").toggle("fast")});$("[data-toggle\x3d'tooltip']").tooltip();$(".tooltip").css("display","block");$(document).on("click",".post-delete",function(a){a.stopPropagation();deletePost($(this))});$(document).on("click",".post-zan",function(a){a.stopPropagation();addZan($(this))});$(document).on("click",".post-comment",function(a){a.stopPropagation();addComment($(this))});$(document).on("click",".post-transmit",function(a){a.stopPropagation();addTransmit($(this))});$(document).on("click",".post-delete",function(a){a.stopPropagation();deletePost($(this))});$container.on("click",".delete-other-btn",function(){var a=$(this).closest(".comment-list").attr("data-id"),b=$(this).closest(".comment-list").attr("create-user-id");0<a&&0<b&&layer.confirm("\u60a8\u8981\u5220\u9664\u8be5\u8bc4\u8bba\u5417\uff1f",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){var c=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"delete",dataType:"json",url:"/cm/comment?cid\x3d"+a+"\x26create_user_id\x3d"+b,beforeSend:function(){},success:function(a){layer.close(c);a.isSuccess?(layer.msg(a.message+",1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(a)},error:function(a){layer.close(c);ajaxError(a)}})},function(){})});audit||buildZanUser();if(imgs)for(var c=imgs.split(";"),b=0;b<c.length;b++){var a="";isVideo(c[b])?(a+='\x3cdiv class\x3d"col-lg-4 col-sm-4"\x3e',a+=getVideoHtml(c[b]),a+="\x3c/div\x3e"):isAudio(c[b])?(a+='\x3cdiv class\x3d"col-lg-4 col-sm-4"\x3e',a+=getAudioHtml(c[b]),a+="\x3c/div\x3e"):isImg(c[b])?a+='\x3cdiv class\x3d"col-lg-4"\x3e\x3cimg src\x3d"'+c[b]+'" class\x3d"img-responsive post-item-img" onClick\x3d"showSingleImg(this);" /\x3e\x3c/div\x3e':layer.msg(getSupportTypeStr());$("#img-container").append(a)}postCreate_time=setTimeAgo(postCreate_time);$("#post-create-time").html(postCreate_time)});var comments,$container,$commentContainer;function buildZanUser(){if(isNotEmpty(zanUsers)){for(var c=zanUsers.split(";"),b="",a=0;a<c.length;a++){var d=c[a];isNotEmpty(d)&&2==d.split(",").length&&(b=a!=c.length-1?b+('\x3ca href\x3d"JavaScript:void(0);" onclick\x3d"linkToMy('+d.split(",")[0]+')"\x3e'+changeNotNullString(d.split(",")[1])+"\x3c/a\x3e\u3001"):b+('\x3ca href\x3d"JavaScript:void(0);" onclick\x3d"linkToMy('+d.split(",")[0]+')"\x3e'+changeNotNullString(d.split(",")[1])+"\x3c/a\x3e"))}$("#zan-users").html('\x3cdiv class\x3d"zan_user"\x3e'+b+"\u7b49"+zanNumber+"\u4eba\u89c9\u5f97\u5f88\u8d5e\x3c/div\x3e")}}function deletePost(c){layer.confirm("\u60a8\u8981\u5220\u9664\u8be5\u6761\u5e16\u5b50\u5417\uff1f\u5220\u9664\u6389\u5c06\u65e0\u6cd5\u6062\u590d\uff0c\u8bf7\u614e\u91cd\uff01",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){createUserId==loginUserId?doDelete(postId,""):layer.prompt({title:"\u8bf7\u8f93\u5165\u60a8\u8981\u5220\u9664\u8be5\u5e16\u5b50\u7684\u539f\u56e0(\u5fc5\u586b)",formType:0},function(b,a){layer.load(1,{shade:[.1,"#fff"]});doDelete(postId,b)})},function(){})}function doDelete(c,b){var a=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"DELETE",url:"/cc/"+circleId+"/post/"+c+"?reason\x3d"+b,dataType:"json",beforeSend:function(){},success:function(b){layer.close(a);b.isSuccess?(layer.msg(b.message+"\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):(layer.msg(b.message),layer.close(a))},error:function(){layer.close(a);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})}function addZan(c){var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"post",data:{table_name:"t_circle_post",content:"\u559c\u6b22",froms:"\u7f51\u9875\u7aef",table_id:postId},url:"/cc/"+circleId+"/post/"+postId+"/zan",dataType:"json",beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?(layer.msg(a.message+"\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):layer.msg(a.message)},error:function(){layer.close(b);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})}function getCommentsRequestParams(){return{current:currentIndex,total:totalPage,table_name:"t_circle_post",table_id:postId,showUserInfo:!0,page_size:pageSize,t:Math.random()}}function getComments(c){var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/cm/comments/paging?"+jsonToGetRequestParams(getCommentsRequestParams()),dataType:"json",beforeSend:function(){$commentContainer.empty()},success:function(a){layer.close(b);if(a.isSuccess)if(0==a.message.length)0==currentIndex?$commentContainer.append("\u8fd8\u6ca1\u6709\u53d1\u8868\u8fc7\u4efb\u4f55\u8bc4\u8bba\uff0c\u8bf7\u7ed9TA\u8bc4\u8bba\u5427\uff01"):$commentContainer.append("\u5df2\u7ecf\u6ca1\u6709\u66f4\u591a\u7684\u8bc4\u8bba\u5566\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9\uff01");else{comments=a.message;for(var c=0;c<comments.length;c++)buildEachCommentRow(c,comments[c]);laypage.render({elem:"item-pager",layout:["prev","page","next","count","skip"],count:a.total,limit:pageSize,theme:"#337ab7",curr:currentIndex+1,jump:function(a,b){console.log(a.curr);console.log(a.limit);b||(currentIndex=a.curr-1,getComments())}})}else ajaxError(a)},error:function(a){layer.close(b);ajaxError(a)}})}function buildEachCommentRow(c,b){var a=setTimeAgo(b.create_time),a='\x3cdiv class\x3d"row comment-list comment-list-padding" data-id\x3d"'+b.id+'" create-user-id\x3d"'+b.create_user_id+'" \x3e\x3cdiv class\x3d"col-lg-1 col-md-1 col-sm-2 col-xs-2"\x3e\x3cimg src\x3d"'+changeNotNullString(b.user_pic_path)+'" width\x3d"40" height\x3d"40" class\x3d"img-rounded hand center-block"\x3e\x3c/div\x3e\x3cdiv class\x3d"col-lg-11 col-md-11 col-sm-10 col-xs-10"\x3e\x3cdiv class\x3d"list-group"\x3e\x3cdiv class\x3d"list-group-item comment-list-item active"\x3e\x3ca href\x3d"JavaScript:void(0);" onclick\x3d"linkToMy('+b.create_user_id+')" target\x3d"_blank" class\x3d"marginRight"\x3e'+changeNotNullString(b.account)+'\x3c/a\x3e\x3cspan class\x3d"marginRight publish-time"\x3e\u53d1\u8868\u4e8e:'+a+'\x3c/span\x3e\x3cspan class\x3d"marginRight publish-time"\x3e\u6765\u81ea:'+changeNotNullString(b.froms)+"\x3c/span\x3e\x3c/div\x3e",a=a+'\x3cdiv class\x3d"list-group-item comment-list-item"\x3e\x3cdiv class\x3d"row"\x3e';if(isNotEmpty(b.blockquote_content)){a+='\x3cdiv class\x3d"col-lg-12"\x3e\x3cblockquote\x3e'+b.blockquote_content;if(isNotEmpty(b.blockquote_account))var d=setTimeAgo(b.blockquote_time),a=a+("\x3csmall\x3e\x3ccite\x3e"+b.blockquote_account+"\x3c/cite\x3e\x26nbsp;\x26nbsp;"+d+"\x3c/small\x3e");a+="\x3c/blockquote\x3e\x3c/div\x3e"}a+='\x3cdiv class\x3d"col-lg-12"\x3e'+changeNotNullString(b.content)+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e";if(isLogin){a+='\x3cdiv class\x3d"list-group-item comment-list-item"\x3e\x3cdiv class\x3d"row"\x3e\x3cdiv class\x3d"col-lg-12 col-sm-12 col-md-12 col-xs-12 text-align-right"\x3e\x3cbutton class\x3d"btn btn-sm btn-primary btn-block pull-right reply-other-btn" style\x3d"width: 60px;" type\x3d"button"\x3e\u56de\u590dTA\x3c/button\x3e';if(isAdmin||b.create_user_id==loginUserId)a+='\x3cbutton class\x3d"btn btn-sm btn-primary pull-right delete-other-btn" style\x3d"width: 60px; margin-right: 5px;" type\x3d"button"\x3e\u5220\u9664\x3c/button\x3e';a+='\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"row"\x3e\x3cdiv class\x3d"col-lg-12 reply-container" table-id\x3d"'+b.table_id+'" table-name\x3d"'+b.table_name+'" style\x3d"display: none;"\x3e\x3cdiv class\x3d"row"\x3e\x3cdiv class\x3d"col-lg-12"\x3e\x3cform class\x3d"form-signin" role\x3d"form"\x3e\x3cfieldset\x3e\x3ctextarea class\x3d"form-control reply-comment-text" placeholder\x3d"\u56de\u590dTA\uff0c\u6700\u591a250\u4e2a\u6587\u5b57\u3002"\x3e\x3c/textarea\x3e\x3c/fieldset\x3e\x3c/form\x3e\x3c/div\x3e\x3cdiv class\x3d"col-lg-12 col-sm-12 col-md-12 col-xs-12 text-align-right" style\x3d"margin-top: 10px;"\x3e\x3cbutton class\x3d"btn btn-sm btn-info btn-block pull-right" style\x3d"width: 60px;" type\x3d"button" onclick\x3d"commentItem(this, '+b.id+", "+b.table_id+');"\x3e\u8bc4\u8bba\x3c/button\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e'}$commentContainer.append(a+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e")}function commentItem(c,b,a){var d=$(c).closest(".reply-container").find(".reply-comment-text").val();isEmpty(d)?(layer.msg("\u8bc4\u8bba\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a"),$(c).closest(".reply-container").find(".reply-comment-text").focus()):doAddComment({table_name:"t_circle_post",table_id:a,content:d,pid:b,froms:"web\u7aef",t:Math.random()})}function addTransmit(c){c=$("#comment").find('[name\x3d"add-comment"]');if(isEmpty(c.val()))c.focus(),layer.msg("\u8f6c\u53d1\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a");else{var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026"),a={froms:"web\u7f51\u9875\u7aef"};a.content=c.val();a.title="\u8f6c\u53d1\u5e16\u5b50";$.ajax({type:"post",data:a,url:"/cc/"+circleId+"/post/"+postId+"/transmit",dataType:"json",beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?(layer.msg(a.message+"\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):(layer.msg(a.message),layer.close(b))},error:function(){layer.close(b);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})}}function addComment(c){c=$("#comment").find('[name\x3d"add-comment"]');isEmpty(c.val())?(c.focus(),layer.msg("\u8bc4\u8bba\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a")):(c={table_name:"t_circle_post",table_id:postId,content:c.val(),froms:"web\u7aef",t:Math.random()},doAddComment(c))}function doAddComment(c){var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"post",data:c,url:"/cc/"+circleId+"/post/"+c.table_id+"/comment",dataType:"json",beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?(layer.msg("\u8bc4\u8bba\u6210\u529f,1\u79d2\u949f\u540e\u81ea\u52a8\u5237\u65b0"),setTimeout("window.location.reload();",1E3)):layer.msg("\u6dfb\u52a0\u8bc4\u8bba\u5931\u8d25\uff0c"+a.message)},error:function(){layer.close(b);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})}function dd(){};