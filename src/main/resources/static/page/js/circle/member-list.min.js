layui.use(["layer","form","laypage"],function(){layer=layui.layer;form=layui.form;laypage=layui.laypage;form.on("switch(has_question)",function(a){$(a.elem).closest(".layui-input-block");a.elem.checked?($(a.elem).closest(".layui-input-block").append('\x3cinput lay-verify\x3d"required" type\x3d"text" name\x3d"question_title" placeholder\x3d"\u8bf7\u8f93\u5165\u7528\u6237\u52a0\u5165\u65f6\u63d0\u793a\u7684\u6807\u9898" class\x3d"layui-input" style\x3d"margin-top: 5px;"/\x3e'),$(a.elem).closest(".layui-input-block").append('\x3cinput lay-verify\x3d"required" type\x3d"text" name\x3d"question_answer" placeholder\x3d"\u8bf7\u8f93\u5165\u7528\u6237\u52a0\u5165\u65f6\u6807\u9898\u7684\u5bc6\u7801" class\x3d"layui-input" style\x3d"margin-top: 5px;"/\x3e')):($(a.elem).closest(".layui-input-block").find('input[name\x3d"question_title"]').remove(),$(a.elem).closest(".layui-input-block").find('input[name\x3d"question_answer"]').remove());console.log(a.elem);console.log(a.elem.checked);console.log(a.value);console.log(a["this"])});form.on("submit(*)",function(a){console.log(a.elem);console.log(a.form);a=a.field;for(var b in a)"on"==a[b]&&(a[b]=!0);inJson(a,"check_post")||(a.check_post=!1);inJson(a,"add_member")||(a.add_member=!1);inJson(a,"has_question")||(a.has_question=!1);inJson(a,"status")||(a.status=!1);a.status=a.status?5:1;saveSetting(a);return!1});$circleEditModal=$("#edit-circle-modal");$("[data-toggle\x3d'tooltip']").tooltip();$(".navbar-nav .nav-main-li").each(function(){$(this).removeClass("active")});$(".nav-circle").addClass("active");$(".tooltip").css("display","block");$tableContainer=$(".table tbody");$(document).on("click",".member-recommend",function(a){a.stopPropagation();recommendMember($(this))});$(document).on("click",".member-delete",function(a){a.stopPropagation();deleteMember($(this))});$(document).on("click",".post-check",function(a){a.stopPropagation();window.open("/cc/"+circleId+"/post/check","_self")});getCircleMembers();canAdmin&&getNoCheckTotal()});var circles,$circleEditModal,$tableContainer;function getNoCheckTotal(){$.ajax({url:"/cc/"+circleId+"/post/nochecktotal?t\x3d"+Math.random(),dataType:"json",beforeSend:function(){},success:function(a){a.isSuccess?0<a.message&&$("button.post-check").text("\u5ba1\u6838\u5e16\u5b50("+a.message+")"):ajaxError(a)},error:function(a){ajaxError(a)}})}function getCircleMembers(){var a=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/cc/"+circleId+"/members?"+jsonToGetRequestParams({page_size:pageSize,current:currentIndex,total:totalPage,t:Math.random()}),dataType:"json",beforeSend:function(){$tableContainer.find("tr").remove();$(".pagination").empty()},success:function(b){layer.close(a);if(b.isSuccess){circles=b.message;if(0==circles.length){0==currentIndex?$tableContainer.append('\x3ctr\x3e\x3ctd colspan\x3d"7"\x3e\u8be5\u5708\u5b50\u8fd8\u6ca1\u6709\u4efb\u4f55\u7684\u6210\u5458\uff01\x3c/td\x3e\x3c/tr\x3e'):$tableContainer.append('\x3ctr\x3e\x3ctd colspan\x3d"7"\x3e\u5df2\u7ecf\u6ca1\u6709\u66f4\u591a\u7684\u6210\u5458\u5566\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9\uff01\x3c/td\x3e\x3c/tr\x3e');return}for(var c=0;c<circles.length;c++)$tableContainer.append(buildEachCircleMemberRow(c,circles[c])),$("#row-index-"+c).data("member",circles[c]);laypage.render({elem:"item-pager",layout:["prev","page","next","count","skip"],count:b.total,limit:pageSize,theme:"#337ab7",curr:currentIndex+1,jump:function(a,b){console.log(a.curr);console.log(a.limit);b||(currentIndex=a.curr-1,getCircleMembers())}})}else ajaxError(b);isLoad=!1},error:function(b){isLoad=!1;layer.close(a);ajaxError(b)}})}function recommendMember(a){var b=$(a).closest("tr").data("member");layer.confirm("\u60a8\u786e\u5b9a\u8981"+(b.member_recommend?"\u53d6\u6d88\u63a8\u8350":"\u63a8\u8350")+"\u8be5\u6210\u5458\u5417\uff0c\u8bf7\u8c28\u614e\uff01",{btn:["\u786e\u5b9a","\u653e\u5f03"]},function(){doRecommend(b.member_id,b.member_recommend)},function(){})}function deleteMember(a){var b=$(a).closest("tr").data("member");layer.confirm("\u60a8\u8981\u5c06\u300a"+b.account+"\u300b\u79fb\u9664\u51fa\u5708\u5b50\u5417\uff1f\u5220\u9664\u6389\u5c06\u65e0\u6cd5\u6062\u590d\uff0c\u8bf7\u614e\u91cd\uff01",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){layer.prompt({title:"\u8bf7\u8f93\u5165\u60a8\u8981\u79fb\u9664\u8be5\u7528\u6237\u7684\u539f\u56e0(\u5fc5\u586b)",formType:0},function(a,d){layer.load(1,{shade:[.1,"#fff"]});var c=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"DELETE",url:"/cc/"+circleId+"/member/"+b.member_id+"?reason\x3d"+a,dataType:"json",beforeSend:function(){},success:function(a){layer.close(c);a.isSuccess?(layer.msg(a.message+"\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):(layer.msg(a.message),layer.close(c))},error:function(){layer.close(c);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})})},function(){})}function buildEachCircleMemberRow(a,b){var c='\x3ctr id\x3d"row-index-'+a+'"\x3e\x3ctd width\x3d"30"\x3e\x3cimg alt\x3d"" src\x3d"'+(isEmpty(b.user_pic_path)?"":b.user_pic_path)+'" width\x3d"25" height\x3d"25"/\x3e\x3c/td\x3e\x3ctd width\x3d"150" class\x3d"cut-text"\x3e\x3ca href\x3d"javascript:void(0);" onclick\x3d"linkToMy('+b.member_id+');"\x3e'+b.account+"\x3c/a\x3e\x3c/td\x3e\x3ctd\x3e"+(b.contribute?b.contribute:0)+"\x3c/td\x3e\x3ctd\x3e"+(0==b.role_type?"\u666e\u901a":1==b.role_type?"\u5708\u4e3b":"\u7ba1\u7406\u5458")+"\x3c/td\x3e\x3ctd\x3e"+(b.member_recommend?"\u63a8\u8350":"\u4e0d\u63a8\u8350")+'\x3c/td\x3e\x3ctd width\x3d"100"\x3e'+b.create_time+'\x3c/td\x3e\x3ctd width\x3d"140"\x3e';canAdmin&&(c+='\x3ca href\x3d"javascript:void(0);" class\x3d"member-recommend" style\x3d"margin-right: 10px;"\x3e'+(b.member_recommend?"\u53d6\u6d88\u63a8\u8350":"\u63a8\u8350")+"\x3c/a\x3e",1!=b.role_type&&b.member_id!=loginUserId&&(c+='\x3ca href\x3d"javascript:void(0);" class\x3d"member-delete" style\x3d"margin-right: 10px;"\x3e\u5220\u9664\x3c/a\x3e'));return c+"\x3c/td\x3e\x3c/tr\x3e"}function doRecommend(a,b){var c=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"POST",url:"/cc/"+circleId+"/member/"+a+"/recommend",data:{recommend:!b},dataType:"json",beforeSend:function(){},success:function(a){layer.close(c);a.isSuccess?(layer.msg("\u63a8\u8350\u6210\u529f\uff0c1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(a)},error:function(a){layer.close(c);ajaxError(a)}})}function buildNotAdminsHtml(a){a='\x3cspan class\x3d"label label-info" data-id\x3d"'+a.member_id+'" onclick\x3d"notClick(this);"\x3e'+a.account+"\x3c/span\x3e";$("#notAdmins").append(a)}function buildAlreadyAdminsHtml(a){a='\x3cspan class\x3d"label label-primary" data-id\x3d"'+a.member_id+'" onclick\x3d"alreadyClick(this);"\x3e'+a.account+"\x3c/span\x3e";$("#alreadyAdmins").append(a)}function notClick(a){var b={};b.member_id=$(a).attr("data-id");b.account=$(a).text();$(a).remove();buildAlreadyAdminsHtml(b)}function alreadyClick(a){var b={};b.member_id=$(a).attr("data-id");b.account=$(a).text();$(a).remove();buildNotAdminsHtml(b)}function admin(a){a=$(a).closest(".modal");var b=a.attr("data-id"),c="";a.find("#alreadyAdmins span").each(function(){c+=$(this).attr("data-id")+","});var c=deleteLastStr(c),d=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/cc/circle/"+b+"/admins/allot?admins\x3d"+c,dataType:"json",beforeSend:function(){},success:function(a){layer.close(d);a.isSuccess?(layer.msg(a.message+",1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(a)},error:function(a){layer.close(d);ajaxError(a)}})}function getAdminMapValue(a){if(a){var b="",c;for(c in a)b+='\x3ca href\x3d"javascript: void(0);" onclick\x3d"linkToMy('+c+');"\x3e'+a[c]+"\x3c/a\x3e,";return deleteLastStr(b)}return""}function getCircleData(a){return $("#row-index-"+a).data("circle")}function showEditCircleModal(a,b){$circleEditModal.modal("show");$circleEditModal.attr("data-index",b);var c=getCircleData(b);$circleEditModal.find('input[name\x3d"name"]').val(c.name);$circleEditModal.find('textarea[name\x3d"circle_desc"]').val(changeNotNullString(c.circle_desc));$circleEditModal.find('input[name\x3d"circle_path"]').val(changeNotNullString(c.circle_path))}function doEdit(a){a=$(a).closest(".modal");var b=$("#row-index-"+a.attr("data-index")).data("circle").id,c={},d=!0;a.find(".form-control").each(function(a){a=$(this).attr("name");var b=$(this).attr("empty");if(b&&"false"==b&&isEmpty($(this).val()))return $(this).focus(),layer.msg($(this).attr("placeholder")),d=!1;c[a]=$(this).val()});if(d){c.cid=b;console.log(c);var e=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:isEmpty(b)?"post":"put",data:c,url:"/cc/circle",dataType:"json",beforeSend:function(){},success:function(a){layer.close(e);a.isSuccess?(layer.msg(a.message+",1\u79d2\u949f\u540e\u81ea\u52a8\u5237\u65b0"),setTimeout("window.location.reload();",1E3)):ajaxError(a)},error:function(a){layer.close(e);ajaxError(a)}})}}function doDelete(a,b){$(a).closest("tr.each-row");var c=getCircleData(b).id;layer.confirm("\u60a8\u8981\u5220\u9664\u8fd91\u6761\u5708\u5b50\u5417\uff1f",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){var a=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"delete",url:"/cc/circle/"+c,dataType:"json",beforeSend:function(){},success:function(b){layer.close(a);b.isSuccess?(layer.msg(b.message+",1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(b)},error:function(b){layer.close(a);ajaxError(b)}})},function(){})}function showCreateModal(a){layer.prompt({title:"\u8f93\u5165\u5708\u5b50\u540d\u79f0\u5e76\u786e\u8ba4(\u8fd8\u80fd\u521b\u5efa"+a+"\u4e2a)",formType:0},function(a,c){var b=layer.load(1,{shade:[.1,"#fff"]});$.ajax({type:"POST",url:"/cc/circle",data:{name:a},dataType:"json",beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?(layer.msg(a.message),layer.close(c)):ajaxError(a)},error:function(a){layer.close(b);ajaxError(a)}})})}function afterSelect(a){$('input[name\x3d"circle_path"]').val(a)}function saveSetting(a){var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"PUT",data:a,url:"/cc/"+circleId+"/setting/"+settingId,dataType:"json",beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?(layer.msg(a.message+",1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(a)},error:function(a){layer.close(b);ajaxError(a)}})};