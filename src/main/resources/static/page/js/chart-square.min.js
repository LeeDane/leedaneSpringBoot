var container;layui.use(["layer","util"],function(){layer=layui.layer;util=layui.util;container=$("#content");window.WebSocket?isLogin?init():layer.confirm("\u662f\u5426\u4ee5\u8bbf\u5ba2\u8eab\u4efd\u56f4\u89c2\uff1f",{btn:["\u786e\u5b9a","\u53bb\u767b\u5f55"]},function(){userId="12344555UNION"+Math.random();init();layer.msg("\u60a8\u5df2\u9009\u62e9\u4ee5\u8bbf\u5ba2\u8eab\u4efd\u56f4\u89c2\uff01",{time:1E3})},function(){linkToLogin()}):layer.alert("WebSockeet not supported by this browser!",{skin:"layui-layer-molv",closeBtn:0},function(){window.open("about:blank","_self").close()});document.oncontextmenu=function(a){a.preventDefault()};document.getElementById("content").onmouseup=function(a){a||(a=window.event);2==a.button&&alert("Mouse up")};setInterval(function(){$("#system-time").html("\u7cfb\u7edf\u5f53\u524d\u65f6\u95f4\u4e3a\uff1a"+(new Date).Format("yyyy-MM-dd HH:mm:ss"))},1E3);setInterval(function(){var a=$(".chat-create-time");if(0<a.length)for(var b=0;b<a.length;b++){var c=a.eq(b),d=c.data("time"),e=c.data("flag"),d=setTimeAgo(d);"left"==e?c.html("\x26nbsp;\x26nbsp;"+d):c.html(d)}},3E4)});var colorsList="#FFC0CB #D8BFD8 #DDA0DD #9932CC #E6E6FA #4169E1 #E0FFFF".split(" ");document.onkeydown=function(a){};var websocket=null,atScrollIndex=0;function setMessageInnerHTML(a){console.log("data---"+a)}function closeWebSocket(){websocket.close()}var ws,pageW=$(document.body).width(),topArray=[100,130,170],topIndex=0;function initWebSocket(){websocket=new WebSocket("ws://129.28.172.37:8089/websocket?id\x3d123");websocket.onerror=function(){setMessageInnerHTML("error")};websocket.onopen=function(a){isLogin?sendMessageToServer(getSendJson(loginUserId,account+"\u52a0\u5165\u804a\u5929\u5ba4",!0)):sendMessageToServer(getSendJson(loginUserId,"\u533f\u540d\u7528\u6237\u52a0\u5165\u804a\u5929\u5ba4",!0))};websocket.onmessage=function(a){log(a.data)};websocket.onclose=function(){isLogin&&sendMessageToServer(getSendJson(loginUserId,account+"\u5df2\u79bb\u5f00\u804a\u5929\u5ba4",!0))};window.onbeforeunload=function(){websocket.close()}}var last=0,isFisrload=!0,flagLoadHistory=!1;function init(){if(0<container.find("#no-load-history").length)container.find("#load-history").remove();else{var a=layer.load("\u8bfb\u53d6\u804a\u5929\u8bb0\u5f55\u2026");$.ajax({url:"/cs/paging?"+jsonToGetRequestParams({page_size:15,last:last,t:Math.random()}),dataType:"json",beforeSend:function(){},success:function(b){layer.close(a);flagLoadHistory=!1;if(b.isSuccess){container.find("#load-history").remove();if((b=b.message)&&0<b.length)for(var c=0;c<b.length;c++)isLogin&&loginUserId==b[c].create_user_id?container.prepend(buildEachRightRow(b[c])):container.prepend(buildEachLeftRow(b[c])),c==b.length-1&&(last=b[c].id);else container.prepend('\x3cdiv id\x3d"no-load-history"\x3e\u6ca1\u6709\u66f4\u591a\u5386\u53f2\u8bb0\u5f55\u5566\x3c/div\x3e');isFisrload&&(container.scrollTop(container[0].scrollHeight),isFisrload=!1,initWebSocket(!0),$("#has-at-style").click(function(){$(this).hide();0<atScrollIndex&&(container.stop(!0),container.animate({scrollTop:$(".chat-list-row").eq(atScrollIndex).offset().top},1E3),atScrollIndex=0)}),container.height(),container.scroll(function(a){a=a||window.event;if(a.wheelDelta){if(0<a.wheelDelta)return}else if(a.detail&&0<a.detail)return;a=container[0].scrollHeight;var b=container.scrollTop();console.log("\u5dee----\x3e"+(a-b)+", scrollT\x3d"+b+", pageH\x3d"+a);!flagLoadHistory&&300<a&&100>b&&(flagLoadHistory=!0,container.prepend('\x3cdiv id\x3d"load-history"\x3e\u52a0\u8f7d\u4e2d\u3002\u3002\u3002\x3c/div\x3e'),console.log("\u5f00\u59cb\u505a\u70b9\u4ec0\u4e48\u5417"),init())}),getActiveUsers(),setInterval("getActiveUsers()","60000"),isLogin&&getScore())}else ajaxError(b);isLoad=!1},error:function(b){flagLoadHistory=!1;container.prepend('\x3cdiv id\x3d"load-history"\x3e\u52a0\u8f7d\u5931\u8d25\uff0c\u8bf7\u91cd\u65b0\u6ed1\u52a8\u518d\u6b21\u52a0\u8f7d\u3002\u3002\u3002\x3c/div\x3e');isLoad=!1;layer.close(a);ajaxError(b)}})}}function getScore(){$.ajax({dataType:"json",url:"sc/score/total",beforeSend:function(){},success:function(a){a.isSuccess?(a=a.message,1>a&&$("#send-play-screen").attr("disabled","disabled"),$("#score").html(a)):ajaxError(a)},error:function(a){ajaxError(a)}})}function getActiveUsers(){$.ajax({dataType:"json",url:"/cs/user/active",beforeSend:function(){},success:function(a){$("#active-users").find(".active-users-item").remove();if(a.isSuccess){if(a=a.message,0<a.length)for(var b,c=0;c<a.length;c++){b=0==c?"one":1==c?"two":2==c?"third":"";var d="";isNotEmpty(a[c].user_pic_path)&&(d=a[c].user_pic_path);$("#active-users").append('\x3ca href\x3d"javascript:void(0);" class\x3d"list-group-item active-users-item" onclick\x3d"linkToMy('+a[c].create_user_id+');"\x3e\x3cimg width\x3d"30" height\x3d"30" class\x3d"img-circle hand" alt\x3d"" src\x3d"'+d+'"  onclick\x3d"showSingleImg(this);"/\x3e\x26nbsp;\x26nbsp; '+a[c].account+'\x3cspan class\x3d"badge '+b+'" style\x3d"margin-top: 7px;"\x3e'+a[c].count+"\x3c/span\x3e\x3c/a\x3e")}}else ajaxError(a)},error:function(a){ajaxError(a)}})}function initWebSocket1(a){ws=new WebSocket("");ws.onmessage=function(a){log(a.data)};ws.onclose=function(a){initWebSocket(!1)};ws.onopen=function(b){a&&ws.send(getSendJson(loginUserId,"\u5927\u5bb6\u597d\uff0c\u6211\u662f"+userName,!0))};ws.onerror=function(a){}}function getSendJson(a,b,c){return JSON.stringify(c?{id:a,content:b,type:"welcome"}:{id:a,content:b})}var log=function(a){a=eval("("+a+")");if(!isLogin||loginUserId!=a.id||!a.type||"welcome"!=a.type)if(a.type&&"error"==a.type)container.append(buildEachErrorRow(a));else{isLogin&&loginUserId==a.id?container.append(buildEachRightRow(a)):container.append(buildEachLeftRow(a));if(a.at_other&&isNotEmpty(a.at_other)){console.log("at--"+a.at_other);for(var b=a.at_other.split(","),c=0;c<b.length;c++)if(loginUserId==b[c]){$("#has-at-style").show();atScrollIndex=$(".chat-list-row").length-1;break}}var b=container.height(),c=container[0].scrollHeight,d=container.scrollTop();400>c-d-b&&container.scrollTop(c-b);"PlayScreen"==a.type&&(b="play-screen-"+getRandomNumber(1E4),c="",isNotEmpty(a.user_pic_path)&&(c=a.user_pic_path),c=isNotEmpty(a.screenText)?'\x3cdiv id\x3d"'+b+'" class\x3d"play-screen"\x3e\x3cspan class\x3d"screen-play-img"\x3e\x3cimg class\x3d"img-circle hand" width\x3d"25" height\x3d"25" src\x3d"'+c+'"\x3e\x3c/span\x3e\x3cspan class\x3d"screen-play-content"\x3e'+a.screenText+"\x3c/span\x3e\x3c/div\x3e":'\x3cdiv id\x3d"'+b+'" class\x3d"play-screen"\x3e\x3cspan class\x3d"screen-play-img"\x3e\x3cimg class\x3d"img-circle hand" width\x3d"25" height\x3d"25" src\x3d"'+c+'"\x3e\x3c/span\x3e\x3cspan class\x3d"screen-play-content"\x3e'+a.content+"\x3c/span\x3e\x3c/div\x3e",$("body").append(c),topIndex+=1,topIndex>topArray.length&&(topIndex=0),c=colorsList[getRandomNumber1(colorsList.length)],b=$("#"+b),b.css("top",topArray[topIndex]+"px"),b.css("background-color",c),b.css("border","1px solid "+c),b.find(".screen-play-content").css("line-height",b.outerHeight()+"px"),playScreen(b),isLogin&&loginUserId==a.id&&getScore())}};function playScreen(a){var b=8E3+1E3*getRandomNumber1(6),c=a.outerWidth();a.animate({right:pageW-c+"px"},b,function(){a.remove()});a.hover(function(){a.stop()},function(){a.animate({right:pageW-c+"px"},b,function(){a.remove()})})}function sendMsg(){var a=ue.getContent();if(isEmpty(a))layer.msg("\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a"),ue.focus();else{var b=$("#at-other-container").children("button");if(b&&0<b.length){for(var c="",d=0;d<b.length;d++)c+=$(b[d]).attr("uid")+",";c=c.substring(0,c.length-1);sendMessageToServer(JSON.stringify({id:loginUserId,at_other:c,content:a}))}else sendMessageToServer(getSendJson(loginUserId,a));ue.setContent("");$("#at-other-container").empty()}}function sendMessageToServer(a){websocket.send(a)}function sendPlayScreen(){var a=ue.getContent();if(isEmpty(a))layer.msg("\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a"),ue.focus();else{var b=$("#at-other-container").children("button");if(b&&0<b.length){for(var c="",d=0;d<b.length;d++)c+=$(b[d]).attr("uid")+",";c=c.substring(0,c.length-1);sendMessageToServer(JSON.stringify({id:loginUserId,at_other:c,content:a,type:"PlayScreen"}))}else sendMessageToServer(JSON.stringify({id:loginUserId,content:a,type:"PlayScreen"}));ue.setContent("");$("#at-other-container").empty()}}function clearMsg(){layer.confirm("\u786e\u5b9a\u6e05\u7a7a\u804a\u5929\u5217\u8868\uff1f",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){container.empty();$("#at-other-container").empty();layer.msg("\u5df2\u6e05\u7a7a ",{icon:1,time:800})},function(){})}function deleteAt(a){$(a).remove()}function atOther(a,b){console.log("account\x3d"+a);var c=$("#at-other-container").children("button");if(c)for(var d=0;d<c.length;d++)if($(c[d]).attr("uid")==b)return;$("#at-other-container").append('\x3cbutton type\x3d"button" class\x3d"btn btn-default btn-xs" uid\x3d"'+b+'" onclick\x3d"deleteAt(this)"\x3e@'+a+' \x3cspan class\x3d"glyphicon glyphicon-trash" aria-hidden\x3d"true"\x3e\x3c/span\x3e\x3c/button\x3e')}function buildEachLeftRow(a){var b=isLogin&&0<a.create_user_id&&a.create_user_id!=loginUserId&&a.account||!isLogin&&0<a.create_user_id&&a.account,b='\x3cdiv class\x3d"row chat-list-row'+(b?" hand":"")+'" '+(b?"onclick\x3d\"atOther('"+a.account+"',"+a.create_user_id+');"':"")+'\x3e\x3cdiv class\x3d"col-lg-1 col-md-1 col-sm-2 col-xs-2" style\x3d"text-align: center;margin-top: 10px;"\x3e',b=isNotEmpty(a.user_pic_path)?b+('\x3cimg style\x3d"width: 40px; Height: 40px;"" class\x3d"img-rounded hand" alt\x3d"" src\x3d"'+a.user_pic_path+'"  onclick\x3d"showSingleImg(this);"/\x3e'):b+'\x3cimg style\x3d"width: 40px; Height: 40px;" class\x3d"img-rounded" alt\x3d""/\x3e',c=setTimeAgo(a.time);return b+='\x3c/div\x3e\x3cdiv class\x3d"col-lg-10 col-md-10 col-sm-8 col-xs-8"\x3e\x3cdiv class\x3d"row" style\x3d"font-family: \'\u5fae\u8f6f\u96c5\u9ed1\'; font-size: 15px; margin-top: 10px;"\x3e\x3cdiv class\x3d"col-lg-12"\x3e\x3cspan class\x3d"chat-user-name"\x3e\x3ca href\x3d"JavaScript:void(0);" onclick\x3d"linkToMy('+a.create_user_id+')"\x3e'+a.account+'\x3c/a\x3e\x3c/span\x3e\x3cspan class\x3d"chat-create-time" data-time\x3d"'+a.time+'" data-flag\x3d"left"\x3e\x26nbsp;\x26nbsp;'+c+'\x3c/span\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"row" style\x3d"font-family: \'\u5fae\u8f6f\u96c5\u9ed1\'; font-size: 17px;margin-top: 5px;"\x3e\x3cdiv class\x3d"col-lg-12"\x3e'+a.content+'\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"col-lg-1 col-md-1 col-sm-2 col-xs-2" style\x3d"text-align: center;margin-top: 10px;"\x3e\x3c/div\x3e\x3c/div\x3e'}function buildEachRightRow(a){var b=setTimeAgo(a.time),b='\x3cdiv class\x3d"row chat-list-row"\x3e\x3cdiv class\x3d"col-lg-1 col-md-1 col-sm-2 col-xs-2" style\x3d"text-align: center;margin-top: 10px;"\x3e\x3c/div\x3e\x3cdiv class\x3d"col-lg-10 col-md-10 col-sm-8 col-xs-8"\x3e\x3cdiv class\x3d"row" style\x3d"font-family: \'\u5fae\u8f6f\u96c5\u9ed1\'; font-size: 15px; margin-top: 10px;"\x3e\x3cdiv class\x3d"col-lg-12" style\x3d"text-align: right;"\x3e\x3cspan class\x3d"chat-create-time" data-time\x3d"'+a.time+'" data-flag\x3d"left"\x3e'+b+'\x3c/span\x3e\x3cspan class\x3d"chat-user-name"\x3e\x3ca href\x3d"JavaScript:void(0);" onclick\x3d"linkToMy('+a.create_user_id+')"\x3e\x26nbsp;\x26nbsp;'+a.account+'\x3c/a\x3e\x3c/span\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"row" style\x3d"font-family: \'\u5fae\u8f6f\u96c5\u9ed1\'; font-size: 17px; margin-top: 5px; text-align: right;"\x3e\x3cdiv class\x3d"col-lg-12"\x3e'+a.content+'\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"col-lg-1 col-md-1 col-sm-2 col-xs-2" style\x3d"text-align: center;margin-top: 10px;"\x3e',b=isNotEmpty(a.user_pic_path)?b+('\x3cimg style\x3d"width: 40px; Height: 40px;" class\x3d"img-rounded carousel-inner hand" alt\x3d"" src\x3d"'+a.user_pic_path+'"  onclick\x3d"showSingleImg(this);"/\x3e'):b+'\x3cimg style\x3d"width: 40px; Height: 40px;" class\x3d"img-rounded carousel-inner " alt\x3d"" src\x3d""/\x3e';return b+"\x3c/div\x3e\x3c/div\x3e"}function buildEachErrorRow(a){a='\x3cdiv class\x3d"row chat-list-row"\x3e\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12" style\x3d"text-align: center;margin-top: 10px; color: #999"\x3e'+a.content;"\x3c/div\x3e\x3c/div\x3e";return a};