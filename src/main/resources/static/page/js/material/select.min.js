layui.use(["layer","laypage"],function(){layer=layui.layer;laypage=layui.laypage;pageSize=10;$materialListContainer=$("#material-row-container");var d=$materialListContainer.width();1130<$(window).width()?materialListImgHight=Math.floor(d/3)-30:(materialListImgHight=Math.floor(modalWidth/3)-30,console.log("\u9ad8\u5ea6\u662f\uff1a"+materialListImgHight));$tabsContainer=$("#material-tabs");isNotEmpty(tabName)?$tabsContainer.find("li").each(function(a){$(this).attr("data-value")==tabName?(type=tabName,$(this).addClass("active")):$(this).removeClass("active")}):($tabsContainer.find("li").eq(0).addClass("active"),type=$tabsContainer.find("li").eq(0).attr("data-value"));getMaterials();$tabsContainer.find("li").on("click",function(a){$tabsContainer.find("li").removeClass("active");$(this).addClass("active");type=$(this).attr("data-value");currentIndex=0;selectObjs={};$("#select-list").find(".has-select-file").remove();getMaterials()});$(document).on("click","div.thumbnail",function(a){a.stopPropagation();a=$(this);var c=a.parent().data("material"),b=0;for(selectObj in selectObjs)b++;if(a.hasClass("click-select"))a.removeClass("click-select"),a.find(".thumbnail-top").remove(),delete selectObjs[c.id],$("#select-file-"+c.id).remove();else{if(b>select-1){layer.msg("\u62b1\u6b49\uff0c\u6700\u591a\u53ea\u80fd\u9009\u62e9"+select+"\u6761\u6570\u636e\uff01");return}selectObjs[c.id]=c.qiniu_path;a.addClass("click-select");a.append('\x3cdiv class\x3d"thumbnail-top"\x3e\x3c/div\x3e');$("#select-list").append('\x3cdiv class\x3d"has-select-file" id\x3d"select-file-'+c.id+'" class\x3d"cut-text"\x3e\x3cspan class\x3d"glyphicon glyphicon-ok" style\x3d"color: green; margin-right: 5px;"\x3e\x3c/span\x3e\x3ca href\x3d"'+c.qiniu_path+'"\x3e'+getFileName(c.qiniu_path)+"\x3c/a\x3e\x3c/div\x3e")}resetContrainHeight()})});var type,materials,$image,$materialListContainer,$tabsContainer,selectObjs={};function resetContrainHeight(){var d=$("#select-list").height();$tabsContainer.css("margin-top",d+20+"px")}function getMaterials(){var d=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/mt/materials?"+jsonToGetRequestParams({page_size:pageSize,current:currentIndex,total:totalPage,type:type,t:Math.random()}),dataType:"json",beforeSend:function(){$materialListContainer.empty();$(".pagination").empty()},success:function(a){layer.close(d);if(a.success){materials=a.message;if(0==materials.length){0==currentIndex?$materialListContainer.append('\x3cdiv class\x3d"col-lg-4 col-md-4 col-sm-12 col-xs-12"\x3e\u6682\u65f6\u6ca1\u6709\u7d20\u6750\uff0c\u8bf7\u524d\u5f80\u7d20\u6750\u7ba1\u7406\u4e2d\u5fc3\u6dfb\u52a0\uff01\x3c/div\x3e'):$materialListContainer.append('\x3cdiv class\x3d"col-lg-4 col-md-4 col-sm-12 col-xs-12"\x3e\u5df2\u7ecf\u6ca1\u6709\u66f4\u591a\u7684\u7d20\u6750\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9\uff01\x3c/div\x3e');return}for(var c=0<$("#select-list").find(".has-select-file").length,b=0;b<materials.length;b++)"\u56fe\u50cf"==type?$materialListContainer.append(buildEachMaterialImgRow(b,materials[b])):"\u97f3\u9891"==type?$materialListContainer.append(buildEachMaterialVideoOrAudioRow(b,materials[b])):$materialListContainer.append(buildEachMaterialFileRow(b,materials[b])),$("#material-row-"+b).data("material",materials[b]);resetContrainHeight();for(b=0;b<materials.length;b++)if(c)for(var e in selectObjs)if(parseInt(e)==materials[b].id){$("#material-row-"+b).find("div.thumbnail").addClass("click-select");$("#material-row-"+b).find("div.thumbnail").append('\x3cdiv class\x3d"thumbnail-top"\x3e\x3c/div\x3e');break}laypage.render({elem:"list-pager",layout:["prev","page","next","count","skip"],count:a.total,limit:pageSize,curr:currentIndex+1,jump:function(a,b){console.log(a.curr);console.log(a.limit);b||(currentIndex=a.curr-1,getMaterials())}})}else ajaxError(a);isLoad=!1},error:function(a){isLoad=!1;layer.close(d);ajaxError(a)}})}function buildEachMaterialImgRow(d,a){var c='\x3cdiv class\x3d"col-lg-4 col-md-4 col-sm-6 col-xs-6" id\x3d"material-row-'+d+'"\x3e\x3cdiv class\x3d"thumbnail"\x3e\x3cimg width\x3d"100%" style\x3d"height: '+materialListImgHight+'px;" src\x3d"'+a.qiniu_path+'" alt\x3d"..." /\x3e\x3cdiv class\x3d"caption"\x3e\x3cdiv class\x3d"cut-text"\x3e'+changeNotNullString(a.create_time)+"\x3c/div\x3e",c=isEmpty(a.material_desc)?c+'\x3ch5 class\x3d"cut-text"\x3e\u6682\u65e0\u63cf\u8ff0\x3c/h5\x3e':c+('\x3ch5 class\x3d"cut-text" title\x3d"'+a.material_desc+'"\x3e'+a.material_desc+"\x3c/h5\x3e");return c+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e"}function getFileName(d){var a=d.replace(/(.*\/)*([^.]+).*/ig,"$2");d=d.replace(/.+\./,"");return a+"."+d}function buildEachMaterialFileRow(d,a){var c='\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12" id\x3d"material-row-'+d+'"\x3e\x3cdiv class\x3d"thumbnail"\x3e\x3cdiv class\x3d"cut-text" style\x3d"margin-left: 10px; margin-right: 10px;"\x3e\u6587\u4ef6\u8def\u5f84\uff1a\x3ca href\x3d"'+a.qiniu_path+'" title\x3d"'+a.qiniu_path+'"\x3e'+getFileName(a.qiniu_path)+'\x3c/a\x3e\x3c/div\x3e\x3cdiv class\x3d"caption"\x3e\x3cdiv class\x3d"cut-text"\x3e\u65f6\u95f4\uff1a'+changeNotNullString(a.create_time)+"\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp; \u6587\u4ef6\u5927\u5c0f\uff1a"+formatFileSize(a.length)+"\x3c/div\x3e",c=isEmpty(a.material_desc)?c+'\x3ch5 class\x3d"cut-text"\x3e\u6682\u65e0\u63cf\u8ff0\x3c/h5\x3e':c+('\x3ch5 class\x3d"cut-text" title\x3d"'+a.material_desc+'"\x3e'+a.material_desc+"\x3c/h5\x3e");return c+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e"}function buildEachMaterialVideoOrAudioRow(d,a){var c=a.path,b='\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12" id\x3d"material-row-'+d+'"\x3e\x3cdiv class\x3d"thumbnail"\x3e\x3cdiv class\x3d"cut-text" style\x3d"margin-left: 10px; margin-right: 10px;"\x3e\u6587\u4ef6\u8def\u5f84\uff1a\x3ca href\x3d"'+a.qiniu_path+'" title\x3d"'+a.qiniu_path+'"\x3e'+getFileName(a.qiniu_path)+'\x3c/a\x3e\x3c/div\x3e\x3cdiv class\x3d"caption"\x3e\x3cdiv class\x3d"cut-text"\x3e\u65f6\u95f4\uff1a'+changeNotNullString(a.create_time)+"\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp; \u6587\u4ef6\u5927\u5c0f\uff1a"+formatFileSize(a.length)+"\x3c/div\x3e";isVideo(c)&&(b=b+'\x3cdiv class\x3d"row"\x3e\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12"\x3e'+getVideoHtml(a.qiniu_path),b+="\x3c/div\x3e\x3c/div\x3e");isAudio(c)&&(b=b+'\x3cdiv class\x3d"row"\x3e\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12"\x3e'+getAudioHtml(a.qiniu_path),b+="\x3c/div\x3e\x3c/div\x3e");b=isEmpty(a.material_desc)?b+'\x3ch5 class\x3d"cut-text"\x3e\u6682\u65e0\u63cf\u8ff0\x3c/h5\x3e':b+('\x3ch5 class\x3d"cut-text" title\x3d"'+a.material_desc+'"\x3e'+a.material_desc+"\x3c/h5\x3e");return b+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e"}function getSelectMaterialData(){return selectObjs};