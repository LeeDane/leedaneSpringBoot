layui.use(["layer","laypage"],function(){layer=layui.layer;laypage=layui.laypage;pageSize=9;initPage(".pagination","getMaterials",10);$materialListContainer=$("#material-row-container");$uploadImgModal=$("#upload-img-modal");var b=$materialListContainer.width();1130<$(window).width()?($uploadImgModal.find(".modal-dialog").css("width",1100),materialListImgHight=Math.floor(b/3)-30):($uploadImgModal.find(".modal-dialog").css("width",$(window).width()-30),materialListImgHight=$(window).width()-30);$progressBar=$(".progress-bar");$progressBar.closest(".progress").hide();$formUpload=$("#form-upload");$formUpload.hide();isNotEmpty(tabName)?$("#material-tabs").find("li").each(function(a){$(this).attr("data-value")==tabName?(type=tabName,$(this).addClass("active")):$(this).removeClass("active")}):($("#material-tabs").find("li").eq(0).addClass("active"),type=$("#material-tabs").find("li").eq(0).attr("data-value"));getMaterials();$("#material-tabs").find("li").on("click",function(a){$("#material-tabs").find("li").removeClass("active");$(this).addClass("active");type=$(this).attr("data-value");currentIndex=0;getMaterials()})});var materials,fileIndex=0,isUploading=!1,$progressBar,$formUpload,$uploadImgModal,$materialListContainer,materialListImgHight,type;function getMaterials(){var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/mt/materials?"+jsonToGetRequestParams({page_size:pageSize,current:currentIndex,total:totalPage,type:type,t:Math.random()}),dataType:"json",beforeSend:function(){$materialListContainer.empty();$(".pagination").empty()},success:function(a){layer.close(b);if(a.isSuccess){materials=a.message;if(0==materials.length){0==currentIndex?$materialListContainer.append('\x3cdiv class\x3d"col-lg-4 col-md-4 col-sm-12 col-xs-12"\x3e\u6682\u65f6\u6ca1\u6709\u66f4\u591a\u7684\u6570\u636e\uff01\x3c/div\x3e'):$materialListContainer.append('\x3cdiv class\x3d"col-lg-4 col-md-4 col-sm-12 col-xs-12"\x3e\u5df2\u7ecf\u6ca1\u6709\u66f4\u591a\u7684\u7d20\u6750\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9\x3c/div\x3e');return}for(var c=0;c<materials.length;c++)"\u56fe\u50cf"==type?$materialListContainer.append(buildEachMaterialImgRow(c,materials[c])):"\u97f3\u9891"==type?$materialListContainer.append(buildEachMaterialVideoOrAudioRow(c,materials[c])):$materialListContainer.append(buildEachMaterialFileRow(c,materials[c]));laypage.render({elem:"item-pager",layout:["prev","page","next","count","skip"],count:a.total,limit:pageSize,theme:"#337ab7",curr:currentIndex+1,jump:function(a,b){console.log(a.curr);console.log(a.limit);b||(currentIndex=a.curr-1,getMaterials())}})}else ajaxError(a);isLoad=!1},error:function(a){isLoad=!1;layer.close(b);ajaxError(a)}})}function addFile(b,a){b||(b="");a||(a="\u6587\u4ef6");fileIndex++;$("#add-file").remove();$formUpload.append('\x3cinput id\x3d"add-file-'+fileIndex+'" '+b+' file-type\x3d"'+a+'" type\x3d"file" name\x3d"myfile" onchange\x3d"haveFileInut(this,);"/\x3e');$("#add-file-"+fileIndex+"").data("index",fileIndex);$("#add-file-"+fileIndex+"").click()}function addVideoOrAudio(){addFile(' accept\x3d"audio/mp4, video/mp4, audio/mpeg" ',"\u97f3\u9891")}function addImage(){$uploadImgModal.modal({backdrop:"static",keyboard:!1});$uploadImgModal.modal("show")}function haveFileInut(b){b=$(b);var a=b.val(),c=b[0],d=a.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1"),a=a.replace(/.+\./,""),d=d+"."+a;$("#upload-material-table").append('\x3ctr class\x3d"each-row" id\x3d"add-file-row-'+fileIndex+'"\x3e\x3ctd\x3e'+d+'\x3c/td\x3e\x3ctd onclick\x3d"addDesc(this);" onkeydown\x3d"saveDesc(event, this);"\x3e\x3c/td\x3e\x3ctd class\x3d"file-status"\x3e\u672a\u4e0a\u4f20\x3c/td\x3e\x3ctd\x3e\x3ca href\x3d"javascript:void(0);" onclick\x3d"deleteFile(this);" style\x3d"margin-left: 10px;"\x3e\u79fb\u9664\x3c/a\x3e\x3c/td\x3e\x3c/tr\x3e');$("#add-file-row-"+fileIndex).data("path",d);$("#add-file-row-"+fileIndex).data("index",fileIndex);$("#add-file-row-"+fileIndex).data("length",c.files[0].size);$("#add-file-row-"+fileIndex).data("type",b.attr("file-type"))}var uuid,task,preAddFileIndex=1;function uploadFiles(){if(isUploading)layer.msg("\u5f53\u524d\u6709\u4efb\u52a1\u5728\u4e0a\u4f20\uff0c\u8bf7\u7a0d\u7b49\u3002\u3002\u3002");else if(1>$formUpload.find("input").length)layer.msg("\u8bf7\u5148\u6dfb\u52a0\u6587\u4ef6");else{$progressBar.closest(".progress").show();layer.msg("\u6b63\u5728\u4e0a\u4f20\uff0c\u8bf7\u52ff\u5173\u95ed\u7a97\u53e3\u3002",{icon:16,shade:.5,time:-1});showProgressStyle(0);isUploading=!0;var b=new FormData(document.getElementById("form-upload"));task=setInterval("getProgress()","100");try{$.ajax({url:"/wul/uploads",type:"POST",cache:!1,data:b,processData:!1,contentType:!1,dataType:"json"}).success(function(a){isUploading=!1;clearInterval(task);layer.closeAll();if(null==a||a.isSuccess){a=a.message;for(var b=0;b<a.length;b++){var d=$formUpload.find("input").eq(b).data("index");d&&(d=$("#add-file-row-"+d),d.addClass("complete"),d.find(".file-status").text("\u5df2\u4e0a\u4f20"),d.data("qiniu_path",a[b]))}$formUpload.empty();$progressBar.closest(".progress").hide()}else layer.msg(a.message)}).error(function(a){isUploading=!1;clearInterval(task);a.isSuccess?layer.msg(a.message):layer.msg("\u4e0a\u4f20\u51fa\u73b0\u5f02\u5e38\uff01")})}catch(a){ajaxError(a)}}}function deleteFile(b){layer.confirm("\u60a8\u8981\u79fb\u9664\u8be5\u6587\u4ef6\u8bb0\u5f55\u5417\uff1f",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){$(b).closest("tr").remove();layer.closeAll()},function(){})}function getProgress(){$.ajax({url:"/wul/getProgress",dataType:"json",beforeSend:function(){},success:function(b){null!=b&&b.isSuccess&&(b=b.message,b=Math.round(b.bytesRead/b.contentLength*100),100==b&&clearInterval(task),showProgressStyle(b),console.log("\u5f53\u524d\u7684\u8fdb\u5ea6\u662f\uff1a"+b))},error:function(b){isUploading=!1;ajaxError(b)}})}function showProgressStyle(b){$progressBar.css("width",b+"%");$progressBar.find(".p-show").text(b+"% \u5df2\u4e0a\u4f20\u5b8c\u6210")}function addDesc(b){var a=$(b).closest("tr"),a=$(b).find("input")&&0<$(b).find("input").length?$(b).find("input").val():a.data("material_desc");$(b).text("");$(b).append('\x3cinput type\x3d"text" class\x3d"form-control" placeholder\x3d"\u56de\u8f66\u4fdd\u5b58\u63cf\u8ff0"/\x3e');$(b).find("input").focus();isNotEmpty(a)&&$(b).find("input").val(a)}function saveDesc(b,a){var c=b||window.event||arguments.callee.caller.arguments[0];c&&13==c.keyCode&&(c=$(a).find("input").val(),$(a).find("input").remove(),$(a).text(c),$(a).closest("tr").data("material_desc",c))}function buildEachMaterialImgRow(b,a){var c='\x3cdiv class\x3d"col-lg-4 col-md-4 col-sm-12 col-xs-12"\x3e\x3cdiv class\x3d"thumbnail"\x3e\x3cimg width\x3d"100%" style\x3d"height: '+materialListImgHight+'px; cursor: pointer;" src\x3d"'+a.qiniu_path+'" alt\x3d"..." onClick\x3d"showSingleImg(this);"/\x3e\x3cdiv class\x3d"caption"\x3e\x3cdiv class\x3d"cut-text"\x3e'+changeNotNullString(a.create_time)+"\x3c/div\x3e",c=isEmpty(a.material_desc)?c+'\x3ch5 class\x3d"cut-text"\x3e\u6682\u65e0\u63cf\u8ff0\x3c/h5\x3e':c+('\x3ch5 class\x3d"cut-text" title\x3d"'+a.material_desc+'"\x3e'+a.material_desc+"\x3c/h5\x3e");return c+='\x3cp\x3e\x3ca href\x3d"javascript:void(0);" class\x3d"btn btn-primary btn-sm" role\x3d"button" onclick\x3d"editMaterial(event, '+a.id+');"\x3e\u7f16\u8f91\x3c/a\x3e \x3ca href\x3d"javascript:void(0);" class\x3d"btn btn-default btn-sm" role\x3d"button" onclick\x3d"deleteMaterial(event, '+a.id+');"\x3e\u5220\u9664\x3c/a\x3e\x3c/p\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e'}function getFileName(b){var a=b.replace(/(.*\/)*([^.]+).*/ig,"$2");b=b.replace(/.+\./,"");return a+"."+b}function buildEachMaterialFileRow(b,a){var c='\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12"\x3e\x3cdiv class\x3d"thumbnail"\x3e\x3cdiv class\x3d"cut-text" style\x3d"margin-left: 10px; margin-right: 10px;"\x3e\u6587\u4ef6\u8def\u5f84\uff1a\x3ca href\x3d"'+a.qiniu_path+'" title\x3d"'+a.qiniu_path+'"\x3e'+a.path+'\x3c/a\x3e\x3c/div\x3e\x3cdiv class\x3d"caption"\x3e\x3cdiv class\x3d"cut-text"\x3e\u65f6\u95f4\uff1a'+changeNotNullString(a.create_time)+"\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp; \u6587\u4ef6\u5927\u5c0f\uff1a"+formatFileSize(a.length)+"\x3c/div\x3e",c=isEmpty(a.material_desc)?c+'\x3ch5 class\x3d"cut-text"\x3e\u6682\u65e0\u63cf\u8ff0\x3c/h5\x3e':c+('\x3ch5 class\x3d"cut-text" title\x3d"'+a.material_desc+'"\x3e'+a.material_desc+"\x3c/h5\x3e");return c+='\x3cp\x3e\x3ca href\x3d"javascript:void(0);" class\x3d"btn btn-primary btn-sm" role\x3d"button" onclick\x3d"editMaterial(event, '+a.id+');"\x3e\u7f16\u8f91\x3c/a\x3e \x3ca href\x3d"javascript:void(0);" class\x3d"btn btn-default btn-sm" role\x3d"button" onclick\x3d"deleteMaterial(event, '+a.id+');"\x3e\u5220\u9664\x3c/a\x3e\x3c/p\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e'}function buildEachMaterialVideoOrAudioRow(b,a){var c=a.path,d='\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12"\x3e\x3cdiv class\x3d"thumbnail"\x3e\x3cdiv class\x3d"cut-text" style\x3d"margin-left: 10px; margin-right: 10px;"\x3e\u6587\u4ef6\u8def\u5f84\uff1a\x3ca href\x3d"'+a.qiniu_path+'" title\x3d"'+a.qiniu_path+'"\x3e'+c+'\x3c/a\x3e\x3c/div\x3e\x3cdiv class\x3d"caption"\x3e\x3cdiv class\x3d"cut-text"\x3e\u65f6\u95f4\uff1a'+changeNotNullString(a.create_time)+"\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp; \u6587\u4ef6\u5927\u5c0f\uff1a"+formatFileSize(a.length)+"\x3c/div\x3e";isVideo(c)&&(d=d+'\x3cdiv class\x3d"row"\x3e\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12"\x3e'+getVideoHtml(a.qiniu_path),d+="\x3c/div\x3e\x3c/div\x3e");isAudio(c)&&(d=d+'\x3cdiv class\x3d"row"\x3e\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12"\x3e'+getAudioHtml(a.qiniu_path),d+="\x3c/div\x3e\x3c/div\x3e");d=isEmpty(a.material_desc)?d+'\x3cdiv class\x3d"cut-text"\x3e\u6682\u65e0\u63cf\u8ff0\x3c/div\x3e':d+('\x3cdiv class\x3d"cut-text" title\x3d"'+a.material_desc+'"\x3e'+a.material_desc+"\x3c/div\x3e");return d+='\x3cp\x3e\x3ca href\x3d"javascript:void(0);" class\x3d"btn btn-primary btn-sm" role\x3d"button" onclick\x3d"editMaterial(event, '+a.id+');"\x3e\u7f16\u8f91\x3c/a\x3e \x3ca href\x3d"javascript:void(0);" class\x3d"btn btn-default btn-sm" role\x3d"button" onclick\x3d"deleteMaterial(event, '+a.id+');"\x3e\u5220\u9664\x3c/a\x3e\x3c/p\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e'}function deleteMaterial(b,a){b.stopPropagation();0<a&&layer.confirm("\u60a8\u8981\u5220\u9664\u8be5\u7d20\u6750\u5417\uff1f",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"delete",dataType:"json",url:"/mt/material/"+a,beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?(layer.msg(a.message+",1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(a)},error:function(a){layer.close(b);ajaxError(a)}})},function(){})}function editMaterial(b,a){b.stopPropagation();layer.msg("\u6682\u65f6\u4e0d\u5f00\u53d1")}function getData(){var b,a,c,d;try{if(b=document.getElementById("add-photo-iframe").contentWindow.getData(),a=b.formData,c=b.fileName,d=b.fileSize,isEmpty(c)||d&&1>d){layer.msg("\u8be5\u6587\u4ef6\u4e0d\u7b26\u5408\u89c4\u8303\uff0c\u8bf7\u91cd\u65b0\u9009\u62e9");return}}catch(f){layer.msg("\u8bf7\u9009\u62e9\u56fe\u7247\uff1a"+f.message);return}var e=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/wul/upload/imgage",type:"POST",cache:!1,data:a,processData:!1,contentType:!1,dataType:"json"}).success(function(a){try{if(layer.close(e),null!=a&&a.isSuccess){fileIndex++;var b=a.message;$("#upload-material-table").append('\x3ctr class\x3d"complete each-row" id\x3d"add-file-row-'+fileIndex+'"\x3e\x3ctd\x3e'+c+'\x3c/td\x3e\x3ctd onclick\x3d"addDesc(this);" onkeydown\x3d"saveDesc(event, this);"\x3e\x3c/td\x3e\x3ctd class\x3d"file-status"\x3e\u5df2\u4e0a\u4f20\x3c/td\x3e\x3ctd\x3e\x3ca href\x3d"javascript:void(0);" onclick\x3d"deleteFile(this);" style\x3d"margin-left: 10px;"\x3e\u79fb\u9664\x3c/a\x3e\x3c/td\x3e\x3c/tr\x3e');$("#add-file-row-"+fileIndex).data("path",c);$("#add-file-row-"+fileIndex).data("qiniu_path",b);$("#add-file-row-"+fileIndex).data("index",fileIndex);$("#add-file-row-"+fileIndex).data("length",d);$("#upload-img-modal").modal("hide")}else ajaxError(a)}catch(g){layer.msg(g)}}).error(function(a){alert(123);layer.close(e);layer.msg(a)})}function submitFiles(){var b=$("#upload-material-table").find(".each-row.complete");if(b&&1>b.length)layer.msg("\u8bf7\u5148\u4e0a\u4f20\u6587\u4ef6\uff01");else{var a=[],c=!1;b.each(function(b){isEmpty($(this).data("qiniu_path"))&&(c=!0);a.push($(this).data())});c?layer.msg("\u65e0\u6cd5\u83b7\u53d6\u670d\u52a1\u5668\u6587\u4ef6\u8def\u5f84\uff0c\u8bf7\u5237\u65b0\u91cd\u8bd5\uff01"):$.ajax({type:"post",url:"/mt/material",data:{materials:JSON.stringify(a)},dataType:"json",beforeSend:function(){},success:function(a){null!=a&&a.isSuccess?(layer.msg(a.message+",1\u79d2\u949f\u540e\u81ea\u52a8\u5237\u65b0"),setTimeout("window.location.reload();",1E3)):ajaxError(a)},error:function(a){ajaxError(a)}})}};