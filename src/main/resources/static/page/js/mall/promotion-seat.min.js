//表单的容器
var promotionFormContainer;layui.use(["table","form","layedit"],function(){table=layui.table;form=layui.form;table.render({elem:"#data-table",height:"full-240",url:"/mall/promotion/seat/paging",page:!0,sort:!0,where:{field:"id",order:"desc"},cols:[[{field:"id",title:"ID",width:80,sort:!0,fixed:"left"},{field:"createUser",title:"\u521b\u5efa\u4eba",width:90},{field:"create_time",title:"\u521b\u5efa\u65f6\u95f4",width:110,sort:!0},{field:"platform",title:"\u5e73\u53f0",width:80,sort:!0},{field:"seat_id",title:"\u63a8\u5e7f\u4f4dID",width:165,sort:!0},{field:"seat_name",title:"\u63a8\u5e7f\u4f4d\u540d\u79f0"},{field:"allotUser",title:"\u5206\u914d\u5bf9\u8c61",width:120},{field:"allot_time",title:"\u5206\u914d\u65f6\u95f4",width:165,sort:!0},{fixed:"right",title:"\u64cd\u4f5c",toolbar:"#operateBar",width:150}]]});table.on("sort(seat-table-filter)",function(a){console.log(a.field);console.log(a.type);isEmpty(a.type)&&(a.type="asc");console.log(this);var b=layer.load(2,{shade:[.1,"#fff"]});table.reload("data-table",{initSort:a,where:{field:a.field,order:a.type},done:function(a,c,f){console.log(a);layer.close(b)}})});table.on("tool(seat-table-filter)",function(a){var b=a.data;if("detail"===a.event)linkToProduct(b.product_id);else if("del"===a.event)layer.confirm("\u786e\u5b9a\u8981\u5220\u9664\u8be5\u63a8\u5e7f\u4f4d\u5417\uff1f\u6b64\u662f\u4e0d\u53ef\u9006\u884c\u4e3a\uff0c\u8bf7\u614e\u91cd\uff01",function(d){var e=layer.load(2,{shade:[.1,"#fff"]});c.ajax({type:"DELETE",url:"/mall/promotion/seat/"+b.id,dataType:"json",success:function(b){layer.close(e);b.isSuccess?(a.del(),layer.msg("\u63a8\u5e7f\u4f4d\u5220\u9664\u6210\u529f\uff0c2\u79d2\u540e\u5c06\u81ea\u52a8\u5237\u65b0"),reloadPage(2E3)):ajaxError(b)},error:function(b){ajaxError(b);layer.close(e)}})});else if("edit"===a.event){promotionFormContainer.show("fast");promotionFormContainer.find("form").find("input[name\x3d'id']").remove();promotionFormContainer.find("form").append('\x3cinput type\x3d"hidden" name\x3d"id" value\x3d"'+b.id+'"/\x3e');promotionFormContainer.find('input[name\x3d"seat_name"]').val(b.seat_name);for(var d=promotionFormContainer.find('select[name\x3d"platform"]').find("option"),e=b.platform,f=0;f<d.length;f++)if(c(d[f]).attr("value")==e){c(d[f]).attr("selected","selected");form.render("select");break}promotionFormContainer.find('select[name\x3d"platform"]').val(b.platform);promotionFormContainer.find('input[name\x3d"seat_id"]').val(b.seat_id)}else if("allot"===a.event){var g=layer.load(2,{shade:[.1,"#fff"]});c.ajax({type:"GET",url:"/mall/promotion/seat/"+b.id+"/noallot/list/",data:b.field,dataType:"json",success:function(a){layer.close(g);if(a.isSuccess){if(0<a.data.length){for(var c='\x3cdl id\x3d"allot-dl"\x3e',d=0;d<a.data.length;d++)var e=a.data[d],c=c+("\x3cdd\x3e\x3cspan\x3e"+e.account+'\x3c/span\x3e\x3ca onclick\x3d"allotObject('+b.id+", "+e.id+');" class\x3d"layui-btn layui-btn-normal layui-btn-xs" lay-event\x3d"del" style\x3d"height: 25px !important; line-height: 25px !important;"\x3e\u5206\u914d\x3c/a\x3e\x3c/dd\x3e');layer.open({title:"\u7ed9"+b.platform+"\u7684\u63a8\u5e7f\u4f4d\u300a"+b.seat_name+"\u300b\u5206\u914d\u5bf9\u8c61",type:1,skin:"layui-layer-rim",area:["420px","340px"],content:c+"\x3c/dl\x3e"})}}else ajaxError(a)},error:function(a){ajaxError(a);layer.close(g)}})}else"delallot"===a.event&&layer.confirm("\u786e\u5b9a\u8981\u89e3\u9664\u8be5\u63a8\u5e7f\u4f4d\u7684\u7528\u6237\u7ed1\u5b9a\u5417\uff1f",function(a){var d=layer.load(2,{shade:[.1,"#fff"]});c.ajax({type:"DELETE",url:"/mall/promotion/seat/"+b.id+"/noallot",data:b.field,dataType:"json",success:function(a){layer.close(d);a.isSuccess?(layer.msg("\u89e3\u9664\u7ed1\u5b9a\u5bf9\u8c61\u6210\u529f\uff0c2\u79d2\u540e\u5c06\u81ea\u52a8\u5237\u65b0"),reloadPage(2E3)):ajaxError(a)},error:function(a){ajaxError(a);layer.close(d)}})})});var c=layui.$;c(".promotion-seat-group .new-promotion-seat-btn ").on("click",function(){promotionFormContainer.toggle("fast");promotionFormContainer.find("form")[0].reset();promotionFormContainer.find("form").find("input[name\x3d'id']").remove()});c("#auto-create-pdd-seats ").on("click",function(){layer.prompt({title:"\u8bf7\u8f93\u5165\u672c\u6b21\u751f\u6210\u7684\u63a8\u5e7f\u4f4d\u6570\u91cf",formType:2,content:'\x3cinput class\x3d"layui-layer-input"\x3e\x3c/input\x3e'},function(a,b){layer.close(b);var d=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");c.ajax({type:"POST",url:"/mall/promotion/seat/auto/create/pdd",data:{number:parseInt(a)},dataType:"json",success:function(a){layer.close(d);a.isSuccess?(layer.msg(a.message+", 2\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(2E3)):ajaxError(a)},error:function(a){ajaxError(a)}})})});form.on("submit(new-promotion-seat-form-submit)",function(a){var b=0<c(this).closest("form").find("input[name\x3d'id']").length,d=layer.load(2,{shade:[.1,"#fff"]});c.ajax({type:b?"PUT":"POST",url:b?"/mall/promotion/seat/"+a.field.id:"/mall/promotion/seat/",data:a.field,dataType:"json",success:function(a){layer.close(d);a.isSuccess?(layer.msg(b?"\u63a8\u5e7f\u4f4d\u4fee\u6539\u6210\u529f\uff0c2\u79d2\u540e\u5c06\u81ea\u52a8\u5237\u65b0":"\u63a8\u5e7f\u4f4d\u6dfb\u52a0\u6210\u529f\uff0c2\u79d2\u540e\u5c06\u81ea\u52a8\u5237\u65b0"),reloadPage(2E3)):ajaxError(a)},error:function(a){ajaxError(a);layer.close(d)}});return!1});form.on("select(platform)",function(a){platform=a.value;platform=a.elem[a.elem.selectedIndex].text;form.render("select")})});function allotObject(c,a){var b=layer.load(2,{shade:[.1,"#fff"]});$.ajax({type:"POST",url:"/mall/promotion/seat/"+c+"/allot/"+a,dataType:"json",success:function(a){layer.close(b);a.isSuccess?(layer.msg("\u5206\u914d\u5bf9\u8c61\u6210\u529f\uff0c2\u79d2\u540e\u5c06\u81ea\u52a8\u5237\u65b0"),reloadPage(2E3)):ajaxError(a)},error:function(a){ajaxError(a);layer.close(b)}})}$(function(){promotionFormContainer=$("#promotion-seat-container");$("#my-layui-btn-group button").on("click",function(c){var a=layer.load(2,{shade:[.1,"#fff"]}),b=$(this);table.reload("data-table",{page:{curr:1},where:{platform:b.attr("value")},done:function(c,e,f){console.log(c);layer.close(a);$("#my-layui-btn-group button").each(function(){$(this).addClass("layui-btn-primary")});b.removeClass("layui-btn-primary")}})})});function buildNewPromotionSeat(){return'\x3cdiv class\x3d"layui-tab layui-tab-brief" lay-filter\x3d"shareLinkBrief"\x3e123555\x3c/div\x3e '}function prevent(c){c.stopPropagation();c.preventDefault?c.preventDefault():0==window.event.returnValue};