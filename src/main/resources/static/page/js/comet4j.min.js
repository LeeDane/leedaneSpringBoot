/*
 * Comet4J JavaScript Client V0.1.0
 * Copyright(c) 2011, jinghai.xiao@gamil.com.
 * http://code.google.com/p/comet4j/
 * This code is licensed under BSD license. Use it as you wish, 
 * but keep this copyright intact.
 */
var JS={version:"0.0.2"};JS.Runtime=function(){var a=navigator.userAgent.toLowerCase(),b=function(b){return b.test(a)},c=b(/opera/),d=b(/firefox/),e=b(/chrome/),g=b(/webkit/),f=!e&&b(/safari/),l=f&&b(/applewebkit\/4/),h=f&&b(/version\/3/),m=f&&b(/version\/4/),k=!c&&b(/msie/),p=k&&b(/msie 7/),q=k&&b(/msie 8/),r=k&&!p&&!q,n=!g&&b(/gecko/),t=n&&b(/rv:1\.8/),u=n&&b(/rv:1\.9/),v=b(/windows|win32/),w=b(/macintosh|mac os x/),x=b(/adobeair/),b=b(/linux/);return{isOpera:c,isFirefox:d,isChrome:e,isWebKit:g,isSafari:f,isSafari2:l,isSafari3:h,isSafari4:m,isIE:k,isIE7:p,isIE8:q,isIE6:r,isGecko:n,isGecko2:t,isGecko3:u,isWindows:v,isMac:w,isAir:x,isLinux:b}}();JS.isOpera=JS.Runtime.isOpera;JS.isFirefox=JS.Runtime.isFirefox;JS.isChrome=JS.Runtime.isChrome;JS.isWebKit=JS.Runtime.isWebKit;JS.isSafari=JS.Runtime.isSafari;JS.isSafari2=JS.Runtime.isSafari2;JS.isSafari3=JS.Runtime.isSafari3;JS.isSafari4=JS.Runtime.isSafari4;JS.isIE=JS.Runtime.isIE;JS.isIE7=JS.Runtime.isIE7;JS.isIE8=JS.Runtime.isIE8;JS.isIE6=JS.Runtime.isIE6;JS.isGecko=JS.Runtime.isGecko;JS.isGecko2=JS.Runtime.isGecko2;JS.isGecko3=JS.Runtime.isGecko3;JS.isWindows=JS.Runtime.isWindows;JS.isMac=JS.Runtime.isMac;JS.isAir=JS.Runtime.isAir;JS.isLinux=JS.Runtime.isLinux;JS.Syntax={nameSpace:function(){if(arguments.length)for(var a,b,c=0,d=arguments.length;c<d;c++)if(b=arguments[c]){b=b.split(".");for(var e=0,d=b.length;e<d;e++)b[e]&&(a=window[b[e]]=window[b[e]]||{})}return a},apply:function(a,b,c){c&&JS.Syntax.apply(a,c);if(a&&b&&"object"==typeof b)for(var d in b)a[d]=b[d];return a},override:function(a,b){if(b){var c=a.prototype;JS.Syntax.apply(c,b);JS.Runtime.isIE&&b.hasOwnProperty("toString")&&(c.toString=b.toString)}},extend:function(){var a=function(a){for(var b in a)this[b]=a[b]},b=Object.prototype.constructor;return function(c,d,e){JS.Syntax.isObject(d)&&(e=d,d=c,c=e.constructor!=b?e.constructor:function(){d.apply(this,arguments)});var g=function(){},f=d.prototype;g.prototype=f;g=c.prototype=new g;g.constructor=c;c.superclass=f;f.constructor==b&&(f.constructor=d);c.override=function(a){JS.Syntax.override(c,a)};g.superclass=g.supr=function(){return f};g.override=a;JS.Syntax.override(c,e);c.extend=function(a){return JS.Syntax.extend(c,a)};return c}}(),callBack:function(a,b,c){if(JS.isFunction(a))return a.apply(b||window,c||[])},isEmpty:function(a,b){return null===a||void 0===a||Ext.isArray(a)&&!a.length||(b?!1:""===a)},isArray:function(a){return"[object Array]"===Object.prototype.toString.apply(a)},isDate:function(a){return"[object Date]"===Object.prototype.toString.apply(a)},isObject:function(a){return!!a&&"[object Object]"===Object.prototype.toString.call(a)},isPrimitive:function(a){return Ext.isString(a)||Ext.isNumber(a)||Ext.isBoolean(a)},isFunction:function(a){return"[object Function]"===Object.prototype.toString.apply(a)},isNumber:function(a){return"number"===typeof a&&isFinite(a)},isString:function(a){return"string"===typeof a},isBoolean:function(a){return"boolean"===typeof a},isElement:function(a){return!!a&&a.tagName},isDefined:function(a){return"undefined"!==typeof a},toArray:function(){return JS.isIE?function(a,b,c,d){d=[];for(var e=0,g=a.length;e<g;e++)d.push(a[e]);return d.slice(b||0,c||d.length)}:function(a,b,c){return Array.prototype.slice.call(a,b||0,c||a.length)}}()};JS.ns=JS.Syntax.nameSpace;JS.apply=JS.Syntax.apply;JS.override=JS.Syntax.override;JS.extend=JS.Syntax.extend;JS.callBack=JS.Syntax.callBack;JS.isEmpty=JS.Syntax.isEmpty;JS.isArray=JS.Syntax.isArray;JS.isDate=JS.Syntax.isDate;JS.isObject=JS.Syntax.isObject;JS.isPrimitive=JS.Syntax.isPrimitive;JS.isFunction=JS.Syntax.isFunction;JS.isNumber=JS.Syntax.isNumber;JS.isString=JS.Syntax.isString;JS.isBoolean=JS.Syntax.isBoolean;JS.isElement=JS.Syntax.isElement;JS.isDefined=JS.Syntax.isDefined;JS.toArray=JS.Syntax.toArray;JS.DomEvent={on:function(a,b,c,d){a.addEventListener?a.addEventListener(b,function(){JS.callBack(c,d,arguments)},!1):a.attachEvent("on"+b,function(){JS.callBack(c,d,arguments)})},un:function(a,b,c,d){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent("on"+b,c)},stop:function(a){a.returnValue=!1;a.preventDefault&&a.preventDefault();JS.DomEvent.stopPropagation(a)},stopPropagation:function(a){a.cancelBubble=!0;a.stopPropagation&&a.stopPropagation()}};JS.on=JS.DomEvent.on;JS.un=JS.DomEvent.un;JS.DelayedTask=function(a,b,c){var d=this,e,g=function(){clearInterval(e);e=null;a.apply(b,c||[])};d.delay=function(f,l,h,m){d.cancel();a=l||a;b=h||b;c=m||c;e=setInterval(g,f)};d.cancel=function(){e&&(clearInterval(e),e=null)}};JS.ns("JS.Observable");JS.Observable=function(a){JS.apply(this,a||JS.toArray(arguments)[0]);this.events&&this.addEvents(this.events);this.listeners&&(this.on(this.listeners),delete this.listeners)};JS.Observable.prototype={on:function(a,b,c,d){JS.isString(a)?this.addListener(a,b,c,d):JS.isObject(a)&&this.addListeners(a,c,d)},fireEvent:function(){var a=JS.toArray(arguments),b=a[0].toLowerCase();if((b=this.events[b])&&!JS.isBoolean(b))return b.fire.apply(b,a.slice(1))},addEvent:function(a){JS.isObject(this.events)||(this.events={});this.events[a]||(JS.isString(a)?this.events[a.toLowerCase()]=!0:a instanceof JS.Event&&(this.events[a.name.toLowerCase()]=a))},addEvents:function(a){if(JS.isArray(a))for(var b=0,c=a.length;b<c;b++)this.addEvent(a[b])},addListener:function(a,b,c,d){a=a.toLowerCase();var e=this.events[a];e&&(JS.isBoolean(e)&&(e=this.events[a]=new JS.Event(a,this)),e.addListener(b,c,d))},addListeners:function(a,b,c){if(JS.isObject(a))for(var d in a)this.addListener(d,a[d],b,c)},removeListener:function(a,b,c){a=a.toLowerCase();(a=this.events[a])&&!JS.isBoolean(a)&&a.removeListener(b,c)},clearListeners:function(){var a=this.events,b,c;for(c in a)b=a[c],JS.isBoolean(b)||b.clearListeners()},clearEvents:function(){var a=this.events;this.clearListeners();for(var b in a)this.removeEvent(b)},removeEvent:function(a){var b=this.events,c;b[a]&&(c=b[a],JS.isBoolean(c)||c.clearListeners(),delete b[a])},removeEvents:function(a){if(JS.isString(a))this.removeEvent(a);else if(JS.isArray(a)&&0<a.length)for(var b=0,c=a.length;b<c;b++)this.removeEvent(a[b])},hasEvent:function(a){return this.events[a]?!0:!1},hasListener:function(a,b,c){a=this.events[a];return JS.isBoolean(a)?!1:a.hasListener(b,c)},suspendEvents:function(){},resumeEvents:function(){}};JS.Event=function(a,b){this.name=a.toLowerCase();this.caller=b;this.listeners=[]};JS.Event.prototype={fire:function(){for(var a=this.listeners,b=a.length-1;-1<b;b--)if(!1===a[b].execute.apply(a[b],arguments))return!1;return!0},addListener:function(a,b,c){b=b||this.caller;-1==this.hasListener(a,b)&&this.listeners.push(new JS.Listener(a,b,c))},removeListener:function(a,b){var c=this.hasListener(a,b);alert(c);-1!=c&&this.listeners.splice(c,1)},hasListener:function(a,b){for(var c=0,d=this.listeners,e=d.length;c<e;c++)if(d[c].equal(a,b))return c;return-1},clearListeners:function(){for(var a=0,b=this.listeners,c=b.length;a<c;a++)b[a].clear();this.listeners.splice(0)}};JS.Listener=function(a,b,c){this.handler=a;this.scope=b;this.o=c};JS.Listener.prototype={execute:function(){return JS.callBack(this.handler,this.scope,arguments)},equal:function(a,b){return this.handler===a?!0:!1},clear:function(){delete this.handler;delete this.scope;delete this.o}};JS.ns("JS.HTTPStatus","JS.XMLHttpRequest");JS.HTTPStatus={100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Unused",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};JS.HTTPStatus.OK=200;JS.HTTPStatus.BADREQUEST=400;JS.HTTPStatus.FORBIDDEN=403;JS.HTTPStatus.NOTFOUND=404;JS.HTTPStatus.TIMEOUT=408;JS.HTTPStatus.SERVERERROR=500;JS.XMLHttpRequest=JS.extend(JS.Observable,{enableCache:!1,timeout:0,isAbort:!1,specialXHR:"",_xhr:null,readyState:0,status:0,statusText:"",responseText:"",responseXML:null,constructor:function(){var a=this;this.addEvents("readyStateChange timeout abort error load progress".split(" "));JS.XMLHttpRequest.superclass.constructor.apply(this,arguments);this._xhr=this.createXmlHttpRequestObject();this._xhr.onreadystatechange=function(){a.doReadyStateChange()}},timeoutTask:null,delayTimeout:function(){this.timeout&&(this.timeoutTask||(this.timeoutTask=new JS.DelayedTask(function(){4!=this._xhr.readyState?this.fireEvent("timeout",this,this._xhr):this.cancelTimeout()},this)),this.timeoutTask.delay(this.timeout))},cancelTimeout:function(){this.timeoutTask&&this.timeoutTask.cancel()},createXmlHttpRequestObject:function(){var a="Msxml2.XMLHTTP.6.0 Msxml2.XMLHTTP.5.0 Msxml2.XMLHTTP.4.0 Msxml2.XMLHTTP.3.0 Msxml2.XMLHTTP Microsoft.XMLHTTP".split(" "),b,c=this.specialXHR;if(c)return JS.isString(c)?new ActiveXObject(c):c;try{b=new XMLHttpRequest}catch(d){for(c=0;c<a.length;++c)try{b=new ActiveXObject(a[c]);break}catch(e){}}finally{return b}},doReadyStateChange:function(){this.delayTimeout();var a=this._xhr;try{this.readyState=a.readyState}catch(c){this.readyState=0}try{this.status=a.status}catch(c){this.status=0}try{this.statusText=a.statusText}catch(c){this.statusText=""}try{this.responseText=a.responseText}catch(c){this.responseText=""}try{this.responseXML=a.responseXML}catch(c){this.responseXML=null}this.fireEvent("readyStateChange",this.readyState,this.status,this,a);3==this.readyState&&200<=this.status&&300>this.status&&this.fireEvent("progress",this,a);if(4==this.readyState){this.cancelTimeout();var b=this.status;0==b?this.fireEvent("error",this,a):200<=b&&300>b?this.fireEvent("load",this,a):400<=b&&408!=b?this.fireEvent("error",this,a):408==b&&this.fireEvent("timeout",this,a)}this.onreadystatechange()},onreadystatechange:function(){},open:function(a,b,c,d,e){b&&(this.enableCache||(b=-1!=b.indexOf("?")?b+("\x26ram\x3d"+Math.random()):b+("?ram\x3d"+Math.random())),this._xhr.open(a,b,c,d,e))},send:function(a){this.delayTimeout();this.isAbort=!1;this._xhr.send(a)},abort:function(){this.isAbort=!0;this.cancelTimeout();this._xhr.abort();if(JS.isIE){var a=this;a._xhr.onreadystatechange=function(){a.doReadyStateChange()}}this.fireEvent("abort",this,this._xhr)},setRequestHeader:function(a,b){this._xhr.setRequestHeader(a,b)},getResponseHeader:function(a){return this._xhr.getResponseHeader(a)},getAllResponseHeaders:function(){return this._xhr.getAllResponseHeaders()},setTimeout:function(a){this.timeout=a}});JS.ns("JS.AJAX");JS.AJAX=function(){var a=new JS.XMLHttpRequest;return{dataFormatError:"\u670d\u52a1\u5668\u8fd4\u56de\u7684\u6570\u636e\u683c\u5f0f\u6709\u8bef",urlError:"\u672a\u6307\u5b9aurl",post:function(b,c,d,e,g){if("string"!==typeof b)throw Error(this.urlError);var f=!0;!1===g&&(f=!1);a.onreadystatechange=function(){4==a.readyState&&f&&JS.callBack(d,e,[a])};a.open("POST",b,f);a.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset\x3dUTF8");a.send(c||null);f||JS.callBack(d,e,[a])},get:function(b,c,d,e,g){if("string"!==typeof b)throw Error(this.urlError);var f=!0;!1===g&&(f=!1);a.onreadystatechange=function(){4==a.readyState&&f&&JS.callBack(d,e,[a])};a.open("GET",b,f);a.setRequestHeader("Content-Type","html/text;charset\x3dUTF8");a.send(c||null);f||JS.callBack(d,e,[a])},getText:function(a,c,d,e,g){this.get(a,c,function(a){e?d.call(e,a.responseText):d(a.responseText)},this,g)},getJson:function(a,c,d,e,g){this.get(a,c,function(a){var b=null;try{b=eval("("+a.responseText+")")}catch(h){throw Error(this.dataFormatError);}JS.callBack(d,e,[b])},this,g)}}}();JS.ns("JS.Connector");JS.Connector=JS.extend(JS.Observable,{version:"0.0.2",SYSCHANNEL:"c4j",LLOOPSTYLE:"lpool",STREAMSTYLE:"stream",CMDTAG:"cmd",url:"",param:"",revivalDelay:100,cId:"",channels:[],workStyle:"",emptyUrlError:"URL\u4e3a\u7a7a",runningError:"\u8fde\u63a5\u6b63\u5728\u8fd0\u884c",dataFormatError:"\u6570\u636e\u683c\u5f0f\u6709\u8bef",running:!1,_xhr:null,lastReceiveMessage:"",constructor:function(){JS.Connector.superclass.constructor.apply(this,arguments);this.addEvents("beforeConnect connect beforeStop stop message revival".split(" "));this._xhr=JS.isIE7?new JS.XMLHttpRequest({specialXHR:"Msxml2.XMLHTTP.6.0"}):new JS.XMLHttpRequest;this._xhr.addListener("progress",this.doOnProgress,this);this._xhr.addListener("load",this.doOnLoad,this);this._xhr.addListener("error",this.doOnError,this);this._xhr.addListener("timeout",this.revivalConnect,this);this.addListener("beforeStop",this.doDrop,this);JS.on(window,"beforeunload",this.doDrop,this)},doDrop:function(a,b,c,d){if(this.running&&this.cId)try{d=new JS.XMLHttpRequest,a=parseUrl(this.url)+this.CMDTAG+"\x3ddrop\x26cid\x3d"+this.cId,d.open("GET",a,!1),d.send(null)}catch(e){}},dispatchServerEvent:function(a){this.fireEvent("message",a.channel,a.data,a.time,this)},translateStreamData:function(a){var b=a;this.lastReceiveMessage&&b&&(b=b.split(this.lastReceiveMessage),b=b.length?b[b.length-1]:"");this.lastReceiveMessage=a;return b},decodeMessage:function(a){var b=null;if(JS.isString(a)&&""!=a){"\x3c"==a.charAt(0)&&(a=a.substring(1,a.length));"\x3e"==a.charAt(a.length-1)&&(a=a.substring(0,a.length-1));a=decodeURIComponent(a);try{b=eval("("+a+")")}catch(c){this.stop("JSON\u8f6c\u6362\u5f02\u5e38");try{console.log("JSON\u8f6c\u6362\u5f02\u5e38:"+a)}catch(d){}}}return b},doOnProgress:function(a){if(this.workStyle===this.STREAMSTYLE&&(a=this.translateStreamData(a.responseText).split("\x3e"),0<a.length))for(var b=0,c=a.length;b<c;b++){var d=this.decodeMessage(a[b]);d&&this.dispatchServerEvent(d)}},doOnError:function(a){this.stop("\u670d\u52a1\u5668\u5f02\u5e38")},doOnLoad:function(a){this.workStyle===this.LLOOPSTYLE&&(a=this.decodeMessage(a.responseText))&&this.dispatchServerEvent(a);this.revivalConnect()},startConnect:function(){if(this.running){var a=parseUrl(this.url)+this.CMDTAG+"\x3dconn\x26cv\x3d"+this.version+this.param;JS.AJAX.get(a,"",function(a){(a=this.decodeMessage(a.responseText))?(a=a.data,this.cId=a.cId,this.channels=a.channels,this.workStyle=a.ws,this._xhr.setTimeout(2*a.timeout),this.fireEvent("connect",a.cId,a.channels,a.ws,a.timeout,this),this.revivalConnect()):this.stop("\u8fde\u63a5\u5931\u8d25")},this)}},revivalConnect:function(){function a(){var a=b._xhr,d=parseUrl(b.url)+b.CMDTAG+"\x3drevival\x26cid\x3d"+b.cId+b.param;a.open("GET",d,!0);a.send(null);b.fireEvent("revival",b.url,b.cId,b)}var b=this;this.running&&setTimeout(a,this.revivalDelay)},start:function(a,b){var c=this;setTimeout(function(){if(!c.url&&!a)throw Error(c.emptyUrlError);c.running||(a&&(c.url=a),b&&JS.isString(b)&&("\x26"!=b.charAt(0)&&(b="\x26"+b),c.param=b),!1!==c.fireEvent("beforeConnect",c.url,c)&&(c.running=!0,c.startConnect()))},1E3)},stop:function(a){if(this.running&&!1!==this.fireEvent("beforeStop",a,this.cId,this.url,this)){this.running=!1;var b=this.cId;this.param=this.cId="";this.adml=[];this.workStyle="";try{this._xhr.abort()}catch(c){}this.fireEvent("stop",a,b,this.url,this)}},getId:function(){return this.cId}});JS.ns("JS.Engine");JS.Engine=function(){var a=JS.extend(JS.Observable,{lStore:[],running:!1,connector:null,constructor:function(){this.addEvents(["start","stop"]);a.superclass.constructor.apply(this,arguments);this.connector=new JS.Connector;this.initEvent()},addListener:function(b,c,d,e){this.running?a.superclass.addListener.apply(this,arguments):this.lStore.push({eventName:b,fn:c,scope:d,o:e})},initEvent:function(){var a=this;this.connector.on({connect:function(b,d,e){a.running=!0;a.addEvents(d);e=0;for(var c=a.lStore.length;e<c;e++){var f=a.lStore[e];a.addListener(f.eventName,f.fn,f.scope)}a.fireEvent("start",b,d,a)},stop:function(b,d,e,g){a.running=!1;a.fireEvent("stop",b,d,e,a);a.clearListeners()},message:function(b,d,e){a.fireEvent(b,d,e,a)}})},start:function(a){this.running||this.connector.start(a)},stop:function(a){this.running&&this.connector.stop(a)},getConnector:function(){return this.connector},getId:function(){return this.connector.cId}});return new a}();function parseUrl(a){return a=0<a.indexOf("?")?a+"\x26":a+"?"};