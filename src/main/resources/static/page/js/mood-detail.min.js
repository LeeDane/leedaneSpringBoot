var last_id=0,first_id=0,maxCommentNumber=250,$commentListContainer=null,commentPageSize=0;layui.use(["layer","util"],function(){layer=layui.layer;util=layui.util;isEmpty(mid)?layer.msg("\u5fc3\u60c5\u4e0d\u5b58\u5728"):(getDetail(),$("[data-toggle\x3d'tooltip']").tooltip(),$(".tooltip").css("display","block"),$commentListContainer=$("#comment-list-container"),getComments(),$container=$(".container"),$container.on("click",".reply-other-btn",function(){$(this).closest(".list-group").find(".reply-container").toggle("fast")}),$container.on("click",".delete-other-btn",function(){var a=$(this).closest(".comment-list").attr("data-id"),c=$(this).closest(".comment-list").attr("create-user-id");0<a&&0<c&&layer.confirm("\u60a8\u8981\u5220\u9664\u8be5\u8bc4\u8bba\u5417\uff1f",{btn:["\u786e\u5b9a","\u70b9\u9519\u4e86"]},function(){var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"delete",dataType:"json",url:"/cm/comment?cid\x3d"+a+"\x26create_user_id\x3d"+c,beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?(layer.msg(a.message+",1\u79d2\u540e\u81ea\u52a8\u5237\u65b0"),reloadPage(1E3)):ajaxError(a)},error:function(a){layer.close(b);ajaxError(a)}})},function(){})}),$(window).scroll(function(a){a=a||window.event;if(a.wheelDelta){if(0<a.wheelDelta)return}else if(a.detail&&0<a.detail)return;a=$(document.body).height();var c=$(window).scrollTop();.2>(a-winH-c)/winH&&!isLoad&&canLoadData&&(isLoad=!0,method="lowloading",getComments())}),$(".can-comment-number").html(maxCommentNumber),$("#comment").find('[name\x3d"add-comment"]').attr("placeholder","\u8bc4\u8bba\u8fd9\u7bc7\u5fc3\u60c5\uff0c\u6700\u591a"+maxCommentNumber+"\u4e2a\u6587\u5b57\u3002"))});var method="firstloading",comments,winH=$(window).height(),isLoad=!1,canLoadData=!0,$container;function getDetail(){$.ajax({url:"/md/detail?mid\x3d"+mid+"\x26t\x3d"+Math.random(),dataType:"json",beforeSend:function(){},success:function(a){if(a.isSuccess&&0<a.message.length){var c=a.message[0],b=setTimeAgo(c.create_time);$("#b-account").find("span").html(changeNotNullString(c.account));$("#b-account").find("img").attr("src",changeNotNullString(c.user_pic_path));$("#b-account").attr("onclick","linkToMy("+c.create_user_id+")");$("#b-create-time").html(b);$("#b-comment-number").html(c.comment_number);$("#b-transmit-number").html(c.transmit_number);$("#b-zan-number").html(c.zan_number);$("#b-read-number").html(c.read_number);if(isNotEmpty(c.zan_users)){for(var e=c.zan_users.split(";"),d="",b=0;b<e.length;b++){var f=e[b];isNotEmpty(f)&&2==f.split(",").length&&(d=b!=e.length-1?d+('\x3ca href\x3d"JavaScript:void(0);" onclick\x3d"linkToMy('+f.split(",")[0]+')"\x3e'+changeNotNullString(f.split(",")[1])+"\x3c/a\x3e\u3001"):d+('\x3ca href\x3d"JavaScript:void(0);" onclick\x3d"linkToMy('+f.split(",")[0]+')"\x3e'+changeNotNullString(f.split(",")[1])+"\x3c/a\x3e"))}$("#zan-users").html('\x3cdiv class\x3d"zan_user"\x3e'+d+"\u7b49"+c.zan_number+"\u4eba\u89c9\u5f97\u5f88\u8d5e\x3c/div\x3e")}$(".row-content").html(a.message[0].content);if(isNotEmpty(c.imgs))for(a=c.imgs.split(";"),e=$("#mood-media-contrainer"),b=0;b<a.length;b++)d="",isVideo(a[b])?d+=getVideoHtml(a[b]):isAudio(a[b])?d+=getAudioHtml(a[b]):isImg(a[b])?d+='\x3cdiv class\x3d"col-lg-4 col-sm-4"\x3e\x3cimg src\x3d"'+a[b]+'" width\x3d"100%" height\x3d"180px" class\x3d"img-responsive" onClick\x3d"showSingleImg(this);" /\x3e\x3c/div\x3e':layer.msg(getSupportTypeStr()),e.append(d);c.can_comment||($("#comment").find('[name\x3d"add-comment"]').attr("placeholder","\u7531\u4e8e\u7528\u6237\u8bbe\u7f6e\uff0c\u65e0\u6cd5\u8bc4\u8bba"),$("#comment").find('[name\x3d"add-comment"]').attr("readonly","readonly"),$("#comment").find("button").prop("disabled",!0))}else ajaxError(a)},error:function(a){ajaxError(a)}})}function getCommentsRequestParams(){commentPageSize=15;"firstloading"!=method&&(commentPageSize=5);return{table_name:"t_mood",table_id:mid,showUserInfo:!0,pageSize:commentPageSize,last_id:last_id,first_id:first_id,method:method,t:Math.random()}}function getComments(a){var c=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({url:"/cm/comments?"+jsonToGetRequestParams(getCommentsRequestParams()),dataType:"json",beforeSend:function(){},success:function(a){layer.close(c);if(a.isSuccess){"firstloading"==method&&$(".comment-list").remove();if(0==a.message.length){canLoadData=!1;$commentListContainer.append('\x3cdiv class\x3d"row comment-list comment-list-padding"\x3e\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12"\x3e\u5df2\u65e0\u66f4\u591a\u8bc4\u8bba\u6570\u636e\x3c/div\x3e\x3c/div\x3e');return}if("firstloading"==method){comments=a.message;for(var b=0;b<comments.length;b++)buildEachCommentRow(b,comments[b]),0==b&&(first_id=comments[b].id),b==comments.length-1&&(last_id=comments[b].id);comments.length<commentPageSize&&(canLoadData=!1,$commentListContainer.append('\x3cdiv class\x3d"row comment-list comment-list-padding"\x3e\x3cdiv class\x3d"col-lg-12 col-md-12 col-sm-12 col-xs-12"\x3e\u5df2\u65e0\u66f4\u591a\u8bc4\u8bba\u6570\u636e\x3c/div\x3e\x3c/div\x3e'));return}for(var d=comments.length,b=0;b<a.message.length;b++)comments.push(a.message[b]),buildEachCommentRow(d+b,a.message[b]),b==a.message.length-1&&(last_id=a.message[b].id)}else ajaxError(a);isLoad=!1},error:function(a){isLoad=!1;layer.close(c);ajaxError(a)}})}function buildEachCommentRow(a,c){var b='\x3cdiv class\x3d"row comment-list comment-list-padding" data-id\x3d"'+c.id+'" create-user-id\x3d"'+c.create_user_id+'"\x3e\x3cdiv class\x3d"col-lg-1 col-md-1 col-sm-2 col-xs-2"\x3e\x3cimg src\x3d"'+changeNotNullString(c.user_pic_path)+'" width\x3d"40" height\x3d"40" class\x3d"img-rounded hand center-block"\x3e\x3c/div\x3e\x3cdiv class\x3d"col-lg-11 col-md-11 col-sm-10 col-xs-10"\x3e\x3cdiv class\x3d"list-group"\x3e\x3cdiv class\x3d"list-group-item comment-list-item active"\x3e\x3ca href\x3d"JavaScript:void(0);" onclick\x3d"linkToMy('+c.create_user_id+')" target\x3d"_blank" class\x3d"marginRight"\x3e'+changeNotNullString(c.account)+'\x3c/a\x3e\x3cspan class\x3d"marginRight publish-time"\x3e'+setTimeAgo(c.create_time)+'\x3c/span\x3e\x3cspan class\x3d"marginRight publish-time"\x3e\u6765\u81ea:'+changeNotNullString(c.froms)+"\x3c/span\x3e\x3c/div\x3e",b=b+'\x3cdiv class\x3d"list-group-item comment-list-item"\x3e\x3cdiv class\x3d"row"\x3e'+('\x3cdiv class\x3d"col-lg-12 comment-list-item-main"\x3e'+changeNotNullString(c.content)+"\x3c/div\x3e"),b=b+blockquote(c),b=b+"\x3c/div\x3e\x3c/div\x3e";if(isLogin){b+='\x3cdiv class\x3d"list-group-item comment-list-item"\x3e\x3cdiv class\x3d"row"\x3e\x3cdiv class\x3d"col-lg-12 col-sm-12 col-md-12 col-xs-12 text-align-right"\x3e\x3cbutton class\x3d"btn btn-sm btn-primary btn-block pull-right reply-other-btn" style\x3d"width: 60px;" type\x3d"button"\x3e\u56de\u590dTA\x3c/button\x3e';if(isAdmin||c.create_user_id==loginUserId)b+='\x3cbutton class\x3d"btn btn-sm btn-primary pull-right delete-other-btn" style\x3d"width: 60px; margin-right: 5px;" type\x3d"button"\x3e\u5220\u9664\x3c/button\x3e';b+='\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"row"\x3e\x3cdiv class\x3d"col-lg-12 reply-container" table-id\x3d"'+c.table_id+'" table-name\x3d"'+c.table_name+'" style\x3d"display: none;"\x3e\x3cdiv class\x3d"row to-comment-contrainer"\x3e\x3cdiv class\x3d"col-lg-12"\x3e\x3cform class\x3d"form-signin" role\x3d"form"\x3e\x3cfieldset\x3e\x3ctextarea class\x3d"form-control reply-comment-text" onkeyup\x3d"updateNumber(this);" placeholder\x3d"\u56de\u590dTA\uff0c\u6700\u591a'+maxCommentNumber+'\u4e2a\u6587\u5b57\u3002"\x3e\x3c/textarea\x3e\x3c/fieldset\x3e\x3c/form\x3e\x3c/div\x3e\x3cdiv class\x3d"col-lg-12 col-sm-12 col-md-12 col-xs-12 text-align-right" style\x3d"margin-top: 10px;"\x3e\x3cspan style\x3d"font-family: \'\u5fae\u8f6f\u96c5\u9ed1\'; font-size: 0.8em;"\x3e\u60a8\u8fd8\u53ef\u4ee5\u8f93\u5165\x3cfont class\x3d"can-comment-number" color\x3d"red"\x3e'+maxCommentNumber+'\x3c/font\x3e\u4e2a\u6587\u5b57\x3c/span\x3e\x3cbutton class\x3d"btn btn-sm btn-info btn-block pull-right" style\x3d"width: 60px;" type\x3d"button" onclick\x3d"commentItem(this, '+c.id+", "+c.table_id+');"\x3e\u8bc4\u8bba\x3c/button\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e'}$commentListContainer.append(b+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e")}function commentItem(a,c,b){a=$(a).closest(".reply-container").find(".reply-comment-text");var e=a.val();isEmpty(e)?(a.focus(),layer.msg("\u8bc4\u8bba\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a")):e.length>maxCommentNumber?(a.focus(),layer.msg("\u8bc4\u8bba\u5b57\u6570\u4e0d\u80fd\u8d85\u8fc7"+maxCommentNumber+"\u4e2a")):doAddComment({table_name:"t_mood",table_id:b,content:e,pid:c,froms:"web\u7aef",t:Math.random()})}function updateNumber(a){var c=$(a);if(isEmpty(c.val()))$("#can-comment-number").html(maxCommentNumber),$(a).closest("div").removeClass("has-error");else{var b=maxCommentNumber-c.val().length;c.closest(".to-comment-contrainer").find(".can-comment-number").html(b);0<=b?$(a).closest("div").removeClass("has-error"):$(a).closest("div").addClass("has-error")}}function addComment(a){a=$("#comment").find('[name\x3d"add-comment"]');isEmpty(a.val())?(a.focus(),layer.msg("\u8bc4\u8bba\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a")):a.val().length>maxCommentNumber?(a.focus(),layer.msg("\u8bc4\u8bba\u5b57\u6570\u4e0d\u80fd\u8d85\u8fc7"+maxCommentNumber+"\u4e2a")):(a={table_name:"t_mood",table_id:mid,content:a.val(),froms:"web\u7aef",t:Math.random()},doAddComment(a))}function doAddComment(a){var c=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"post",data:a,url:"/cm/comment",dataType:"json",beforeSend:function(){},success:function(a){layer.close(c);a.isSuccess?(layer.msg("\u8bc4\u8bba\u6210\u529f,1\u79d2\u949f\u540e\u81ea\u52a8\u5237\u65b0"),setTimeout("window.location.reload();",1E3)):layer.msg("\u6dfb\u52a0\u8bc4\u8bba\u5931\u8d25\uff0c"+a.message)},error:function(){layer.close(c);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})}function dd(){};