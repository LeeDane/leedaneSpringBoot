$(function(){$("#show-login-qr-code-btn").on("click",function(){window.WebSocket?(init(),$("#load-qr-code").modal("show")):layer.msg("\u60a8\u5f53\u524d\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u626b\u63cf\u767b\u5f55\u529f\u80fd\u3002")});$(".form-signin-heading-small").on("click",function(){"\u767b\u5f55"==$(this).text()?($("#login-container").show(),$("#register-container").hide()):($("#register-container").show(),$("#login-container").hide())});$("#remember").click(function(){1==$(this).prop("checked")&&layer.msg("\u8003\u8651\u5230\u7cfb\u7edf\u5b89\u5168\u6027\uff0c\u4e0d\u5f00\u653e\u6b64\u9879\u76ee")})});function refresh(){$("#captcha_img").attr("src","/kaptcha?"+Math.random())}function openOauth2Link(a){if(isEmpty(a))layer.msg("\u8981\u8df3\u8f6c\u7684\u94fe\u63a5\u4e0d\u80fd\u4e3a\u7a7a");else{var c=decodeURI(window.location.href),b="/";-1<c.indexOf("ref\x3d")&&(b=c.substring(c.indexOf("ref\x3d")+4,c.length),-1==b.indexOf("?")&&-1<b.indexOf("\x26")&&(b=b.substring(0,b.indexOf("\x26"))));window.open(a+"?url\x3d"+window.btoa(encodeURI(b)),"_self")}}function rgRefresh(){$("#rg_captcha_img").attr("src","/kaptcha?"+Math.random())}function doLogin(){var a=$("#account").val();if(isEmpty(a))layer.msg("\u8bf7\u8f93\u5165\u8d26\u53f7"),$("#account").focus();else{var c=$("#password").val();if(isEmpty(c))layer.msg("\u8bf7\u8f93\u5165\u5bc6\u7801"),$("#password").focus();else{var b=$("#img-code").val();if(isEmpty(b))layer.msg("\u8bf7\u8f93\u5165\u9a8c\u8bc1\u7801"),$("#img-code").focus();else{var d=new JSEncrypt;d.setPublicKey($("#publicKey").val());var a={account:a,pwd:d.encrypt($.md5(c)),remember:$("#remember").prop("checked"),code:b,t:Math.random()},e=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"post",data:a,url:"/us/login",dataType:"json",withCredentials:!0,beforeSend:function(a){},success:function(a){layer.close(e);if(a.success)layer.msg(a.message),a=getURLParam(window.location.href,"ref"),isEmpty(a)&&(a="/index"),window.location.href=a;else{var b='\x3cdiv class\x3d"alert alert-warning alert-dismissible" role\x3d"alert"\x3e\x3cbutton type\x3d"button" class\x3d"close" data-dismiss\x3d"alert"\x3e\x3cspan aria-hidden\x3d"true"\x3e\x26times;\x3c/span\x3e\x3cspan class\x3d"sr-only"\x3eClose\x3c/span\x3e\x3c/button\x3e\x3cstrong\x3e\u8b66\u544a!\x3c/strong\x3e'+a.message+"\x3c/div\x3e";$("#errorMessage").html(b);4039==a.responseCode&&refresh()}},error:function(a){layer.close(e);ajaxError(a)}})}}}}function doRegister(){var a=$("#rg-account").val();if(isEmpty(a))layer.msg("\u8bf7\u8f93\u5165\u8d26\u53f7"),$("#rg-account").focus();else{var c=$("#rg-password").val();if(isEmpty(c))layer.msg("\u8bf7\u8f93\u5165\u5bc6\u7801"),$("#rg-password").focus();else{var b=$("#rg-confirmPassword").val();if(isEmpty(b))layer.msg("\u8bf7\u8f93\u5165\u786e\u8ba4\u5bc6\u7801"),$("#rg-confirmPassword").focus();else if(c!=b)layer.msg("\u4e24\u6b21\u8f93\u5165\u7684\u5bc6\u7801\u4e0d\u5339\u914d"),$("#rg-confirmPassword").focus();else{var d=$("#rg-phone").val();if(isEmpty(d)||11!=d.length)layer.msg("\u8bf7\u8f93\u5165\u6b63\u786e\u7684\u624b\u673a\u53f7\u7801"),$("#rg-phone").focus();else{var e=$("#rg_img-code").val();if(isEmpty(e))layer.msg("\u8bf7\u8f93\u5165\u9a8c\u8bc1\u7801"),$("#rg_img-code").focus();else{var f=new JSEncrypt;f.setPublicKey($("#publicKey").val());var a={mobilePhone:f.encrypt(d),account:a,confirmPassword:f.encrypt($.md5(b)),password:f.encrypt($.md5(c)),code:e,t:Math.random()},g=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"post",data:a,url:"us/phone/register/noValidate",dataType:"json",withCredentials:!0,beforeSend:function(a){},success:function(a){layer.close(g);a.success?(layer.msg(a.message),reloadPage(100)):(a='\x3cdiv class\x3d"alert alert-warning alert-dismissible" role\x3d"alert"\x3e\x3cbutton type\x3d"button" class\x3d"close" data-dismiss\x3d"alert"\x3e\x3cspan aria-hidden\x3d"true"\x3e\x26times;\x3c/span\x3e\x3cspan class\x3d"sr-only"\x3eClose\x3c/span\x3e\x3c/button\x3e\x3cstrong\x3e\u8b66\u544a!\x3c/strong\x3e'+a.message+"\x3c/div\x3e",$("#registerErrorMessage").html(a))},error:function(a){layer.close(g);ajaxError(a)}})}}}}}}var websocket;function init(){window.WebSocket?initWebsocket():layer.alert("WebSockeet not supported by this browser!",{skin:"layui-layer-molv",closeBtn:0},function(){closeModal();$("#show-login-qr-code-btn").hide()})}document.onkeydown=function(a){var c=a||window.event||arguments.callee.caller.arguments[0];c&&13==c.keyCode&&doLogin()};function initWebsocket(){websocket=new WebSocket("ws://129.28.172.37:8089/scanLogin");websocket.onerror=function(){setMessageInnerHTML("error")};websocket.onopen=function(a){};websocket.onmessage=function(a){a=eval("("+a.data+")");"login"==a.message?checkToken(a.token,a.userid):loadQRCode(a.message)};websocket.onclose=function(){};window.onbeforeunload=function(){websocket.close()}}function setMessageInnerHTML(a){alert("data---"+a)}function checkToken(a,c){var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");layer.msg("\u6b63\u5728\u68c0\u67e5\u6821\u9a8c");$.ajax({type:"post",data:{token:a,userid:c,t:Math.random()},url:"/us/scan/check",dataType:"json",beforeSend:function(b){b.setRequestHeader("token",a);b.setRequestHeader("userid",c)},success:function(a){a.success?reloadPage(1):ajaxError(a)},error:function(a){layer.close(b);ajaxError(a)}})}function closeWebSocket(){websocket.close()}function loadQRCode(a){var c=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({data:"cnid\x3d"+a,url:"/tl/loginQrCode",dataType:"json",beforeSend:function(){},success:function(a){layer.close(c);a.success?$("#modal-qr-code-img").attr("src",a.message):layer.msg(a.message);console.log(a)},error:function(){layer.close(c);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})}function closeModal(){$("#load-qr-code").modal("hide")};