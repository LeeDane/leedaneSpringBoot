$(function(){$("#show-login-qr-code-btn").on("click",function(){window.WebSocket?(init(),$("#load-qr-code").modal("show")):layer.msg("\u60a8\u5f53\u524d\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u626b\u63cf\u767b\u5f55\u529f\u80fd\u3002")});$(".form-signin-heading-small").on("click",function(){"\u767b\u5f55"==$(this).text()?($("#login-container").show(),$("#register-container").hide()):($("#register-container").show(),$("#login-container").hide())});$("#remember").click(function(){1==$(this).prop("checked")&&layer.msg("\u8bf7\u52ff\u5728\u4e0d\u5b89\u5168\u7684\u5730\u65b9\u52fe\u9009\u6b64\u9879")})});function doLogin(){var a=$("#account").val();if(isEmpty(a))layer.msg("\u8bf7\u8f93\u5165\u8d26\u53f7");else{var b=$("#password").val();if(isEmpty(b))layer.msg("\u8bf7\u8f93\u5165\u5bc6\u7801");else{var c=new JSEncrypt;c.setPublicKey($("#publicKey").val());var a={account:a,pwd:c.encrypt($.md5(b)),remember:$("#remember").prop("checked"),t:Math.random()},d=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"post",data:a,url:"/us/login",dataType:"json",withCredentials:!0,beforeSend:function(a){},success:function(a){layer.close(d);a.isSuccess?(layer.msg(a.message),a=getURLParam(window.location.href,"ref"),isEmpty(a)&&(a="/index"),window.location.href=a):(a='\x3cdiv class\x3d"alert alert-warning alert-dismissible" role\x3d"alert"\x3e\x3cbutton type\x3d"button" class\x3d"close" data-dismiss\x3d"alert"\x3e\x3cspan aria-hidden\x3d"true"\x3e\x26times;\x3c/span\x3e\x3cspan class\x3d"sr-only"\x3eClose\x3c/span\x3e\x3c/button\x3e\x3cstrong\x3e\u8b66\u544a!\x3c/strong\x3e'+a.message+"\x3c/div\x3e",$("#errorMessage").html(a))},error:function(a){layer.close(d);ajaxError(a)}})}}}function doRegister(){var a=$("#rg-account").val();if(isEmpty(a))layer.msg("\u8bf7\u8f93\u5165\u8d26\u53f7"),$("#rg-account").focus();else{var b=$("#rg-password").val();if(isEmpty(b))layer.msg("\u8bf7\u8f93\u5165\u5bc6\u7801"),$("#rg-password").focus();else{var c=$("#rg-confirmPassword").val();if(isEmpty(c))layer.msg("\u8bf7\u8f93\u5165\u786e\u8ba4\u5bc6\u7801"),$("#rg-confirmPassword").focus();else if(b!=c)layer.msg("\u4e24\u6b21\u8f93\u5165\u7684\u5bc6\u7801\u4e0d\u5339\u914d"),$("#rg-confirmPassword").focus();else{var d=$("#rg-phone").val();if(isEmpty(d)||11!=d.length)layer.msg("\u8bf7\u8f93\u5165\u6b63\u786e\u7684\u624b\u673a\u53f7\u7801"),$("#rg-phone").focus();else{var e=new JSEncrypt;e.setPublicKey($("#publicKey").val());var a={mobilePhone:e.encrypt(d),account:a,confirmPassword:e.encrypt($.md5(c)),password:e.encrypt($.md5(b)),t:Math.random()},f=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({type:"post",data:a,url:"us/phone/register/noValidate",dataType:"json",withCredentials:!0,beforeSend:function(a){},success:function(a){layer.close(f);a.isSuccess?(layer.msg(a.message),reloadPage(100)):(a='\x3cdiv class\x3d"alert alert-warning alert-dismissible" role\x3d"alert"\x3e\x3cbutton type\x3d"button" class\x3d"close" data-dismiss\x3d"alert"\x3e\x3cspan aria-hidden\x3d"true"\x3e\x26times;\x3c/span\x3e\x3cspan class\x3d"sr-only"\x3eClose\x3c/span\x3e\x3c/button\x3e\x3cstrong\x3e\u8b66\u544a!\x3c/strong\x3e'+a.message+"\x3c/div\x3e",$("#registerErrorMessage").html(a))},error:function(a){layer.close(f);ajaxError(a)}})}}}}}var websocket;function init(){window.WebSocket?initWebsocket():layer.alert("WebSockeet not supported by this browser!",{skin:"layui-layer-molv",closeBtn:0},function(){closeModal();$("#show-login-qr-code-btn").hide()})}document.onkeydown=function(a){var b=a||window.event||arguments.callee.caller.arguments[0];b&&13==b.keyCode&&doLogin()};function initWebsocket(){websocket=new WebSocket("ws://129.28.172.37:8089/scanLogin");websocket.onerror=function(){setMessageInnerHTML("error")};websocket.onopen=function(a){};websocket.onmessage=function(a){a=eval("("+a.data+")");"login"==a.message?checkToken(a.token,a.userid):loadQRCode(a.message)};websocket.onclose=function(){};window.onbeforeunload=function(){websocket.close()}}function setMessageInnerHTML(a){alert("data---"+a)}function checkToken(a,b){var c=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");layer.msg("\u6b63\u5728\u68c0\u67e5\u6821\u9a8c");$.ajax({type:"post",data:{token:a,userid:b,t:Math.random()},url:"/us/scan/check",dataType:"json",beforeSend:function(c){c.setRequestHeader("token",a);c.setRequestHeader("userid",b)},success:function(a){a.isSuccess?reloadPage(1):ajaxError(a)},error:function(a){layer.close(c);ajaxError(a)}})}function closeWebSocket(){websocket.close()}function loadQRCode(a){var b=layer.load("\u52aa\u529b\u52a0\u8f7d\u4e2d\u2026");$.ajax({data:"cnid\x3d"+a,url:"/tl/loginQrCode",dataType:"json",beforeSend:function(){},success:function(a){layer.close(b);a.isSuccess?$("#modal-qr-code-img").attr("src",a.message):layer.msg(a.message);console.log(a)},error:function(){layer.close(b);layer.msg("\u7f51\u7edc\u8bf7\u6c42\u5931\u8d25")}})}function getURLParam(a,b){a||(a=window.location.href);var c=(new RegExp("[\x26,?]"+b+"\x3d([^\\\x26]*)","i")).exec(a);return null==c?"":c[1]}function closeModal(){$("#load-qr-code").modal("hide")};